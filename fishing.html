<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://mrdindoin.ddns.net/ingo/images/favicon.ico?r=wof01">
<title>ë ˆíŠ¸ë¡œ ëŒ€ë¬¼ ë‚šì‹œ (ì›¹ í”„ë¡œí† íƒ€ì…)</title>
<style>
  html,body{height:100%;margin:0;background:#111;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Pretendard,Roboto,Arial}
  .wrap{display:flex;flex-direction:column;height:100%}
  /* ìƒë‹¨ ìº”ë²„ìŠ¤ */
  #lake {
    flex:1;
    image-rendering: pixelated;       /* ë ˆíŠ¸ë¡œ ê²° ì‚´ë¦¬ê¸° */
    image-rendering: crisp-edges;
    background:#7aa; display:block; width:100%;
  }
  /* í•˜ë‹¨ ë©”ë‰´ ë°” (ìŠ¤ìƒ· ëŠë‚Œì˜ ëª©ì¬ ë²„íŠ¼) */
  .menu {
    display:grid;
    grid-template-columns: repeat(6,1fr);
    gap:8px; padding:10px; background:#1b1b1b; border-top:1px solid #333;
  }
  button {
    padding:12px 10px; font-weight:700; letter-spacing:0.02em;
    background:linear-gradient(#caa26a,#a47b3e); color:#2a1c0a;
    border:2px solid #6c4a22; border-radius:6px; box-shadow: inset 0 2px 0 #e7d0a0, 0 2px 0 rgba(0,0,0,.25);
    cursor:pointer; user-select:none;
  }
  button:active { transform:translateY(1px) }
  .hud {
    position:fixed; left:12px; top:10px; color:#eee; font-size:14px; text-shadow:0 1px 0 #000;
    background:rgba(0,0,0,.35); padding:6px 8px; border-radius:6px; line-height:1.25;
  }
  .toast {
    position:fixed; right:12px; top:10px; background:rgba(0,0,0,.55); color:#fff; padding:8px 10px; border-radius:6px; font-size:14px;
  }
</style>
</head>
<body>
<div class="wrap">
  <canvas id="lake"></canvas>

  <div class="hud" id="hud"></div>
  <div class="toast" id="toast" style="display:none"></div>

  <div class="menu">
    <button id="btnReady">ì¤€ë¹„/ìºìŠ¤íŒ…</button>
    <button id="btnTune">ì¡°ì ˆ(ë“œë™)</button>
    <button id="btnBait">ë¨¹ì´</button>
    <button id="btnDayNight">ë‚®/ë°¤</button>
    <button id="btnLog">í™•ì¸(ì¡°ê³¼)</button>
    <button id="btnQuit">ì¢…ë£Œ</button>
  </div>
</div>

<script>
/* ====== ê¸°ë³¸ ìƒíƒœ ====== */
const canvas = document.getElementById('lake');
const ctx = canvas.getContext('2d');
const hud = document.getElementById('hud');
const toast = document.getElementById('toast');

let W=0,H=0, DPR=window.devicePixelRatio||1;
function resize(){
  const rect = canvas.getBoundingClientRect();
  W = Math.floor(rect.width * DPR);
  H = Math.floor(rect.height * DPR);
  canvas.width = W; canvas.height = H;
}
addEventListener('resize', resize, {passive:true}); resize();

/* ì›”ë“œ/ê²Œì„ ìƒíƒœ */
const state = {
  day:true,                                // ë‚®/ë°¤
  wind:0.6,                                // íŒŒë„ ì„¸ê¸°
  drag:0.45,                               // ë“œë™(ì¡°ì ˆ)
  lineLen:0,                               // ë¼ì¸ ê¸¸ì´
  cast:false,                              // ìºìŠ¤íŒ… ìƒíƒœ
  bite:false,                              // ì…ì§ˆ ì¤‘
  hookset:false,                           // í›…ì…‹ ì„±ê³µ
  tension:0,                               // ë¼ì¸ ì¥ë ¥(ì†ë§›)
  baitIndex:0,
  baits:[
    {name:'ì§€ë ì´', biteRate:1.0, size:[0.8,1.2]},
    {name:'ë–¡ë°¥',   biteRate:1.2, size:[0.7,1.1]},
    {name:'ì˜¥ìˆ˜ìˆ˜', biteRate:0.9, size:[0.9,1.4]},
    {name:'ìƒˆìš°',   biteRate:0.7, size:[1.0,1.8]},
  ],
  bobber:{x:0,y:0,vx:0,vy:0, restY:0},
  lastBiteAt:0,
  rng:Math.random
};

const species = [
  {name:'ë¶•ì–´', base:1.0, rare:0.70},
  {name:'ì‰ì–´', base:1.5, rare:0.18},
  {name:'ê°€ë¬¼ì¹˜', base:2.0, rare:0.08},
  {name:'í–¥ì–´', base:1.7, rare:0.04},
];

function showToast(msg, ms=1000){
  toast.textContent = msg; toast.style.display='block';
  clearTimeout(showToast._t); showToast._t = setTimeout(()=>toast.style.display='none', ms);
}

/* ====== UI ë°”ì¸ë”© ====== */
document.getElementById('btnReady').onclick = () => {
  if (!state.cast) castLine(); else reel();
};
document.getElementById('btnTune').onclick = () => {
  state.drag = +(Math.min(0.9, Math.max(0.1, state.drag + (state.drag<0.9?0.1:-0.8)))).toFixed(2);
  showToast(`ë“œë™: ${Math.round(state.drag*100)}%`);
};
document.getElementById('btnBait').onclick = () => {
  state.baitIndex = (state.baitIndex+1)%state.baits.length;
  showToast(`ë¨¹ì´: ${state.baits[state.baitIndex].name}`);
};
document.getElementById('btnDayNight').onclick = () => {
  state.day = !state.day;
  showToast(state.day?'â˜€ï¸ ë‚® ëª¨ë“œ':'ğŸŒ™ ë°¤ ëª¨ë“œ');
};
document.getElementById('btnLog').onclick = () => {
  const log = JSON.parse(localStorage.getItem('catchLog')||'[]');
  if(!log.length){ alert('ì¡°ê³¼ ì—†ìŒ'); return; }
  const txt = log.map(r=>`${r.time}  ${r.sp}  ${r.len.toFixed(1)}cm`).join('\n');
  alert('[ì¡°ê³¼ ê¸°ë¡]\n' + txt);
};
document.getElementById('btnQuit').onclick = () => {
  if(confirm('ê²Œì„ì„ ì¢…ë£Œí• ê¹Œìš”? (ì¡°ê³¼ ë¡œê·¸ëŠ” ìœ ì§€ë¨)')){
    resetAll();
  }
};

canvas.addEventListener('click', e=>{
  // ì°Œ ê·¼ì²˜ í´ë¦­ ì‹œ í›…ì…‹
  if(state.bite && !state.hookset){
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * DPR;
    const y = (e.clientY - r.top) * DPR;
    const dx = x - state.bobber.x, dy = y - state.bobber.y;
    if(dx*dx+dy*dy < (30*DPR)**2) {
      state.hookset = true;
      showToast('í›…ì…‹!');
    }
  }
});

/* ====== ìºìŠ¤íŒ…/ë¦´ë§/ì…ì§ˆ ====== */
function castLine(){
  state.cast = true;
  state.hookset = false; state.bite=false; state.tension=0;
  const x = W*0.62 + (state.rng()-0.5)*W*0.15;
  const y = H*0.55 + (state.rng()-0.5)*H*0.02;
  state.bobber.x = x; state.bobber.y = y;
  state.bobber.vx = 0; state.bobber.vy = 0;
  state.bobber.restY = y - 6*DPR;
  state.lineLen = Math.hypot(x - W*0.1, y - H*0.75);
  showToast('ìºìŠ¤íŒ…!');
  scheduleBite();
}

function reel(){
  if(!state.cast) return;
  // ëœë”© ë‹¨ê³„
  if(state.hookset){
    state.tension += (0.6 - state.drag) * 0.6;      // ë“œë™ì´ ë‚®ìœ¼ë©´ ì¥ë ¥ ìƒìŠ¹
    state.tension = Math.max(0, Math.min(1, state.tension));
    // ì¼ì • íšŸìˆ˜ ë¦´ë§ ì‹œ ì„±ê³µ
    if(state.tension > 0.85){ loseFish('ì¥ë ¥ ê³¼ë‹¤! ë¼ì¸ì´ í„°ì¡Œë‹¤'); return; }
    if(state.tension < 0.15){ loseFish('ì¥ë ¥ ë¶€ì¡±! ë°”ëŠ˜ì´ ë¹ ì¡Œë‹¤'); return; }
    // ê²Œì´ì§€ ì¶•ì 
    if(!reel._p) reel._p = 0;
    reel._p += 0.18 + (Math.random()*0.08);
    if(reel._p >= 1){
      catchFish();
      reel._p = 0;
    }
  } else {
    // ì…ì§ˆ ì „ ë¦´ë§ì€ ì°Œë§Œ ì¡°ê¸ˆ ëŒë¦¼
    state.bobber.x -= 8*DPR;
  }
}

/* ì…ì§ˆ ìŠ¤ì¼€ì¤„ë§ */
function scheduleBite(){
  // ë‚®/ë°¤, ë¨¹ì´ì— ë”°ë¼ ê°€ì¤‘
  const bait = state.baits[state.baitIndex];
  const base = bait.biteRate * (state.day?1.0:1.25);
  // 2~6ì´ˆ ì‚¬ì´
  const t = 2000 + (6000-2000)*(1/base);
  state.lastBiteAt = performance.now() + t*(0.6 + Math.random()*0.8);
}

function maybeBite(now){
  if(state.bite || state.hookset || !state.cast) return;
  if(now >= state.lastBiteAt){
    state.bite = true;
    showToast('íˆ­â€¦ (ì…ì§ˆ)');
  }
}

function loseFish(reason){
  showToast(reason, 1400);
  state.cast=false; state.bite=false; state.hookset=false; state.tension=0;
}

/* ì¡°ê³¼ ê¸°ë¡ */
function catchFish(){
  const bait = state.baits[state.baitIndex];
  // ì–´ì¢… ê²°ì • (ë°¤/ë¨¹ì´ ê°€ì¤‘ì¹˜ë¡œ í¬ê·€ë„ ì•½ê°„ ìƒí–¥)
  const r = Math.random();
  let sp = species[0];
  let acc=0;
  for(const s of species){
    const w = s.rare * (state.day?1.0:1.25) * (bait.name==='ìƒˆìš°'?1.35:1.0);
    acc += w;
    if(r <= acc){ sp = s; break; }
  }
  // ê¸¸ì´(cm)
  const len = 20 + 10*sp.base * (Math.random()*bait.size[1] + bait.size[0]);
  const rec = {time:new Date().toLocaleString(), sp:sp.name, len};
  const log = JSON.parse(localStorage.getItem('catchLog')||'[]'); log.unshift(rec);
  localStorage.setItem('catchLog', JSON.stringify(log.slice(0,50)));
  showToast(`${sp.name} ${len.toFixed(1)}cm ëœë”©!`, 1500);
  state.cast=false; state.bite=false; state.hookset=false; state.tension=0;
}

/* ====== ë Œë”ë§ ====== */
function drawBG(){
  // í•˜ëŠ˜
  const sky = ctx.createLinearGradient(0,0,0,H*0.5);
  sky.addColorStop(0, state.day?'#bfe2ff':'#05111f');
  sky.addColorStop(1, state.day?'#e5f6ff':'#0b1c33');
  ctx.fillStyle = sky; ctx.fillRect(0,0,W,H*0.5);

  // ìˆ˜ë©´
  const water = ctx.createLinearGradient(0,H*0.5,0,H);
  water.addColorStop(0, state.day?'#8fb7c9':'#17364a');
  water.addColorStop(1, state.day?'#6ca0b2':'#0f2a3b');
  ctx.fillStyle = water; ctx.fillRect(0,H*0.5,W,H*0.5);

  // ì¢Œì¸¡ ì›ê²½ ì‚°/ì„¬ ì‹¤ë£¨ì—£(í”½ì…€í’)
  ctx.fillStyle = state.day?'#6f886f':'#2f3a36';
  ctx.fillRect(0,H*0.52,W*0.55,8*DPR);
  ctx.fillStyle = state.day?'#5b7b5b':'#26332e';
  ctx.fillRect(W*0.55,H*0.52,W*0.45,10*DPR);

  // ìˆ˜ì´ˆ
  ctx.fillStyle = state.day?'#2d6b3a':'#164427';
  for(let i=0;i<40;i++){
    const x = W*0.55 + i*W*0.01;
    const h = 10*DPR + Math.sin(i*0.7)*4*DPR;
    ctx.fillRect(x,H*0.5 - h, 2*DPR, h);
  }
}

function drawLineAndBobber(dt){
  const b = state.bobber;
  // íŒŒë„/ë¶€ë ¥
  const t = performance.now()/1000;
  const wave = Math.sin(t*2 + b.x*0.002) * 0.6*DPR * state.wind;
  b.vy += (b.restY - b.y)*0.02 + wave*0.05;
  b.vy *= 0.92; b.y += b.vy;

  // ì…ì§ˆ ëª¨ì…˜
  if(state.bite && !state.hookset){
    b.y += Math.sin(t*22)*1.2*DPR + 0.8*DPR;
  }
  if(state.hookset){
    // ì‹¸ì›€: ì¢Œìš° ê¸‰ë³€
    b.x += (Math.sin(t*8)*2 + (Math.random()-0.5)*2)*DPR*(1.2-state.drag);
    // ì¥ë ¥ ë³€í™”
    state.tension = Math.max(0, Math.min(1, state.tension + (Math.random()-0.5)*0.06 + (0.5-state.drag)*0.02));
  }

  // ë¼ì¸
  ctx.strokeStyle = '#e8e0cf'; ctx.lineWidth = 2*DPR;
  ctx.beginPath();
  const rodX = W*0.1, rodY = H*0.75;
  const midX = (rodX + b.x)/2, midY = (rodY + b.y)/2 - 20*DPR;
  ctx.moveTo(rodX, rodY);
  ctx.quadraticCurveTo(midX, midY, b.x, b.y);
  ctx.stroke();

  // ì°Œ
  ctx.save();
  ctx.translate(b.x, b.y);
  ctx.fillStyle = '#ff3535';
  ctx.fillRect(-2*DPR, -16*DPR, 4*DPR, 16*DPR);
  ctx.fillStyle = '#222';
  ctx.fillRect(-2*DPR, -3*DPR, 4*DPR, 3*DPR);
  ctx.restore();

  // ì†ë§› ê²Œì´ì§€
  if(state.hookset){
    const gw = 160*DPR, gh = 12*DPR;
    ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(W- gw - 20*DPR, 20*DPR, gw, gh);
    const v = state.tension; // 0~1
    ctx.fillStyle = v<0.7 ? '#9fe870' : v<0.85 ? '#ffd166' : '#ef476f';
    ctx.fillRect(W- gw - 20*DPR, 20*DPR, gw*v, gh);
  }
}

function drawRod(){
  // ê°„ë‹¨í•œ ë‚šì‹¯ëŒ€ ì‹¤ë£¨ì—£
  ctx.strokeStyle = '#1a1814'; ctx.lineWidth = 4*DPR;
  ctx.beginPath(); ctx.moveTo(W*0.06,H*0.86); ctx.lineTo(W*0.12,H*0.72); ctx.stroke();
}

/* ====== ë£¨í”„ ====== */
let last=performance.now();
function loop(now){
  const dt = Math.min(33, now-last); last=now;
  ctx.clearRect(0,0,W,H);
  drawBG(); drawRod();

  if(state.cast){ drawLineAndBobber(dt); }
  maybeBite(now);

  // HUD
  hud.innerHTML = [
    `ëª¨ë“œ: ${state.day?'ë‚®':'ë°¤'}`,
    `ë¨¹ì´: ${state.baits[state.baitIndex].name}`,
    `ë“œë™: ${Math.round(state.drag*100)}%`,
    state.cast ? (state.hookset? 'ëœë”© ì¤‘ğŸ¯' : (state.bite?'ì…ì§ˆ! í´ë¦­í•´ í›…ì…‹ ğŸŸ':'ëŒ€ê¸° ì¤‘â€¦')) : 'ëŒ€ê¸°',
  ].join('<br>');

  requestAnimationFrame(loop);
}
loop(performance.now());

function resetAll(){
  state.cast=false; state.bite=false; state.hookset=false;
  state.tension=0; state.lineLen=0;
}

/* ì²« ì§„ì…: ì°Œ ìœ„ì¹˜ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì¤‘ì•™ ê·¼ì²˜ë¡œ */
state.bobber.x = W*0.6; state.bobber.y = H*0.55; state.bobber.restY = state.bobber.y - 6*DPR;
</script>
</body>
</html>
