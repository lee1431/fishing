<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>방치형 아이템 획득 - Motion</title>
  <style>
    html, body { height:100%; margin:0; background:#070a10; color:#e8eefc; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 18px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .card { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; flex:1; min-width:260px; position:relative; overflow:hidden; }
    .big { font-size: 22px; }
    button {
      background: rgba(49,210,255,.12);
      color:#e8eefc;
      border:1px solid rgba(49,210,255,.35);
      padding:10px 12px; border-radius:14px;
      cursor:pointer;
    }
    button:disabled { opacity:.45; cursor:not-allowed; }
    .muted { opacity:.7; font-size:12px; }
    .log { height: 320px; overflow:auto; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18); margin-left:8px; font-size:12px; opacity:.85; }

    /* ===== Motion Layer ===== */
    .fx-layer{
      position:absolute; inset:0;
      pointer-events:none;
    }

    /* Floating gold text */
    .float-text{
      position:absolute;
      left: 18px;
      top: 24px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(8px) scale(0.98);
      animation: floatUp 680ms ease-out forwards;
      text-shadow: 0 0 12px rgba(49,210,255,.25);
      white-space:nowrap;
    }
    @keyframes floatUp{
      0%   { opacity:0; transform: translateY(10px) scale(0.98); filter: blur(.2px); }
      20%  { opacity:1; }
      100% { opacity:0; transform: translateY(-26px) scale(1.02); filter: blur(.0px); }
    }

    /* Chest icon + opening motion */
    .chest-wrap{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .chest{
      width: 58px; height: 46px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      position: relative;
      transform-origin: 50% 80%;
    }
    .chest:before{
      content:"";
      position:absolute; left:8px; right:8px; top:9px; height:10px;
      border-radius: 10px;
      background: rgba(255,255,255,.09);
      border: 1px solid rgba(255,255,255,.10);
    }
    .chest:after{
      content:"";
      position:absolute; left:18px; right:18px; top:19px; height:18px;
      border-radius: 10px;
      background: rgba(49,210,255,.10);
      border: 1px solid rgba(49,210,255,.22);
    }

    /* New chest pulse */
    .chest.pulse{
      animation: pulse 520ms ease-out;
    }
    @keyframes pulse{
      0% { transform: scale(1); }
      35% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    /* Open chest */
    .chest.open{
      animation: openChest 520ms ease-out;
    }
    @keyframes openChest{
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.06) rotate(-2deg); }
      55% { transform: scale(1.10) rotate(3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* Spark particles */
    .spark{
      position:absolute;
      width: 6px; height: 6px;
      border-radius: 999px;
      opacity: 0;
      animation: spark 520ms ease-out forwards;
    }
    @keyframes spark{
      0% { opacity:0; transform: translate(0,0) scale(0.9); }
      15% { opacity:1; }
      100% { opacity:0; transform: translate(var(--dx), var(--dy)) scale(0.8); }
    }
	
	.log-i0 { color:#ffd86b; font-weight:700; } /* 최고 */
	.log-i1 { color:#ffb86b; }
	.log-i2 { color:#7fd4ff; }
	.log-i3 { color:#6ad66a; }
	.log-i4 { color:#9fa8ff; }
	.log-i5 { color:#c7c7c7; }
	.log-i6 { color:#6f7785; } /* 최하 */
  </style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="card" id="goldCard">
      <div class="big">GOLD: <span id="gold">0</span></div>
      <div class="muted">초당 골드: <span id="gps">1</span> <span class="pill" id="boostPill" style="display:none;">BOOST x2</span></div>
      <div style="margin-top:10px" class="row">
        <button id="buyGps">채집 속도 업 (비용 <span id="gpsCost">20</span>)</button>
        <button id="boostBtn">부스트 10초 (비용 50)</button>
      </div>

      <div class="fx-layer" id="goldFx"></div>
    </div>

    <div class="card" id="chestCard">
      <div class="big">CHEST: <span id="chest">0</span></div>

      <div class="chest-wrap">
        <div class="chest" id="chestIcon" aria-hidden="true"></div>
        <div class="muted">다음 상자까지: <span id="chestEta">--</span>초</div>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="openChest">상자 열기</button>
        <button id="buyChestRate">상자 획득 속도 업 (비용 <span id="chestCost">40</span>)</button>
      </div>
      <div class="muted" style="margin-top:8px">
        드랍: 일반 80% / 레어 18% / 에픽 2%
      </div>

      <div class="fx-layer" id="chestFx"></div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="big">획득 로그</div>
    <div class="log" id="log"></div>
  </div>
</div>

<script>
(() => {
  // ===== State =====
  const S = {
    gold: 0,
    gps: 1,
    chest: 0,
    chestInterval: 10, // sec
    chestTimer: 0,
    gpsLevel: 1,
    chestLevel: 1,
    boostUntil: 0
  };

  // ===== Economy =====
  const gpsCost = () => Math.floor(20 * Math.pow(1.35, S.gpsLevel-1));
  const chestCost = () => Math.floor(40 * Math.pow(1.40, S.chestLevel-1));

  // ===== Drop table =====
  const ITEMS = {
    common: ["녹슨 못", "마른 나뭇잎", "돌멩이", "구리 조각", "낡은 천"],
    rare:   ["은빛 톱니", "단단한 가죽", "푸른 수정", "정밀 베어링"],
    epic:   ["황금 코어", "고대 룬", "심연의 결정"]
  };
  function rollRarity(){
    const r = Math.random();
    if (r < 0.80) return "common";
    if (r < 0.98) return "rare";
    return "epic";
  }
  function rollItem(rarity){
    const arr = ITEMS[rarity];
    return arr[Math.floor(Math.random()*arr.length)];
  }

  // ===== UI =====
  const el = (id)=>document.getElementById(id);
  const goldEl = el("gold");
  const gpsEl = el("gps");
  const chestEl = el("chest");
  const chestEtaEl = el("chestEta");
  const logEl = el("log");
  const gpsCostEl = el("gpsCost");
  const chestCostEl = el("chestCost");
  const boostPill = el("boostPill");

  const buyGpsBtn = el("buyGps");
  const buyChestBtn = el("buyChestRate");
  const openChestBtn = el("openChest");
  const boostBtn = el("boostBtn");

  const goldFx = el("goldFx");
  const chestFx = el("chestFx");
  const chestIcon = el("chestIcon");

  const fmt = (n)=>Math.floor(n).toLocaleString("ko-KR");

  function addLog(line, rarity){
	  const p = document.createElement("div");
	  p.textContent = line;

	  if (rarity){
		p.classList.add("log-" + rarity);
	  }

	  logEl.prepend(p);
	}

  function isBoosting(){ return performance.now() < S.boostUntil; }
  function currentGps(){ return S.gps * (isBoosting() ? 2 : 1); }

  function updateUI(){
    goldEl.textContent = fmt(S.gold);
    gpsEl.textContent = currentGps().toFixed(1);
    chestEl.textContent = fmt(S.chest);

    const eta = Math.max(0, S.chestInterval - S.chestTimer);
    chestEtaEl.textContent = eta.toFixed(1);

    gpsCostEl.textContent = fmt(gpsCost());
    chestCostEl.textContent = fmt(chestCost());

    buyGpsBtn.disabled = S.gold < gpsCost();
    buyChestBtn.disabled = S.gold < chestCost();
    openChestBtn.disabled = S.chest < 1;
    boostBtn.disabled = S.gold < 50 || isBoosting();

    boostPill.style.display = isBoosting() ? "inline-block" : "none";
  }

  // ===== Motion helpers =====
  function popGold(amount, labelPrefix="+"){
    // 너무 자주 뜨면 난잡하니: 작은 amount는 합쳐서 보여주는 느낌으로 가능
    const d = document.createElement("div");
    d.className = "float-text";
    d.textContent = `${labelPrefix}${amount}G`;
    goldFx.appendChild(d);
    d.addEventListener("animationend", ()=>d.remove(), {once:true});
  }

  function chestPulse(){
    chestIcon.classList.remove("pulse");
    void chestIcon.offsetWidth; // reflow for restart animation
    chestIcon.classList.add("pulse");
  }

  function chestOpenFX(){
    chestIcon.classList.remove("open");
    void chestIcon.offsetWidth;
    chestIcon.classList.add("open");

    // spark burst near chest icon
    const rect = chestIcon.getBoundingClientRect();
    const host = chestFx.getBoundingClientRect();

    // chest center in chestFx coordinates
    const cx = rect.left - host.left + rect.width*0.55;
    const cy = rect.top  - host.top  + rect.height*0.35;

    const n = 12;
    for (let i=0;i<n;i++){
      const s = document.createElement("div");
      s.className = "spark";
      const ang = Math.random()*Math.PI*2;
      const dist = 30 + Math.random()*40;
      const dx = Math.cos(ang)*dist;
      const dy = Math.sin(ang)*dist;

      s.style.left = `${cx}px`;
      s.style.top  = `${cy}px`;
      s.style.setProperty("--dx", `${dx}px`);
      s.style.setProperty("--dy", `${dy}px`);

      // 색감은 코드에 지정하지 말라고 했던 건 "차트"에 해당하는 룰이라 여기선 OK.
      // 그래도 심플하게: rarity 느낌은 openChest에서 따로 한 번 더.
      s.style.background = "rgba(49,210,255,.85)";
      s.style.boxShadow = "0 0 14px rgba(49,210,255,.35)";

      chestFx.appendChild(s);
      s.addEventListener("animationend", ()=>s.remove(), {once:true});
    }
  }

  // ===== Actions =====
  buyGpsBtn.onclick = () => {
    const c = gpsCost();
    if (S.gold < c) return;
    S.gold -= c;
    S.gpsLevel += 1;
    S.gps = S.gps + 0.8;
    addLog(`채집 속도 업! (Lv.${S.gpsLevel})`,'');
    popGold(c, "-"); // 비용도 이모션으로
    updateUI();
  };

  buyChestBtn.onclick = () => {
    const c = chestCost();
    if (S.gold < c) return;
    S.gold -= c;
    S.chestLevel += 1;
    S.chestInterval = Math.max(2.5, S.chestInterval * 0.88);
    addLog(`상자 획득 속도 업! (Lv.${S.chestLevel})`,'');
    popGold(c, "-");
    updateUI();
  };

  boostBtn.onclick = () => {
    if (S.gold < 50 || isBoosting()) return;
    S.gold -= 50;
    S.boostUntil = performance.now() + 10_000;
    addLog(`부스트 시작! (10초 x2)`,'');
    popGold(50, "-");
    updateUI();
  };

  openChestBtn.onclick = async () => {
  if (S.chest < 1) return;

  // 버튼 연타 방지
  openChestBtn.disabled = true;

  try {
    // 서버에 상자 오픈 요청
    const res = await fetch("https://mrdindoin.ddns.net/gti/api/open_chest", { method: "POST" });
    const data = await res.json();
    if (!data.ok) throw new Error("server_fail");

    // 클라 상태 반영
    S.chest -= 1;

    // 연출
    chestOpenFX();

    const rarity = data.rarity;         // i0 ~ i6
	const itemName = data.item_name || data.item; // 표시용 우선
	const bonus  = data.bonus;
	
	S.gold += bonus;
	
	const tagMap = { i0:"신화", i1:"전설", i2:"영웅", i3:"레어", i4:"고급", i5:"일반", i6:"잡템" };
	const tag = tagMap[rarity] || rarity;
	
	addLog(`상자 OPEN → [${tag}] ${itemName} (+${bonus}G)`, rarity);
    popGold(bonus, "+");

    updateUI();
  } catch (e) {
    addLog("서버 응답 실패… (네트워크/서버 확인)");
  } finally {
    openChestBtn.disabled = S.chest < 1; // 상태에 맞게
  }
};
  
  
  

  // ===== Main loop =====
  let last = performance.now();
  let goldCarry = 0; // 작은 골드 누적해서 일정량 이상일 때만 이모션(너무 도배 방지)
  function tick(now){
    const dt = Math.min(0.05, (now - last)/1000);
    last = now;

    // passive gold
    const g = currentGps() * dt;
    S.gold += g;
    goldCarry += g;

    // gold emotion: 0.8G 이상 모이면 한번 띄움(도배 방지)
    if (goldCarry >= 0.8){
      const amt = Math.floor(goldCarry);
      if (amt >= 1) popGold(amt, "+");
      goldCarry -= amt;
    }

    // chest timer
    S.chestTimer += dt;
    if (S.chestTimer >= S.chestInterval){
      const k = Math.floor(S.chestTimer / S.chestInterval);
      S.chest += k;
      S.chestTimer -= k * S.chestInterval;
      addLog(`상자 획득! (+${k})`,'');

      // chest emotion: 펄스(새 상자 느낌)
      chestPulse();
    }

    updateUI();
    requestAnimationFrame(tick);
  }

  updateUI();
  addLog("시작. 시간이 흐르면 골드/상자가 자동으로 쌓인다.",'');
  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
