<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#B57CFF" />
  <title>STANCE — FishingLog HUD Map</title>

  <!-- Leaflet (지도) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg0:#05080f;
      --bg1:#070c18;
      --ink:#e9f1ff;
      --muted:#a8b6d6;
      --line:rgba(140,200,255,.20);
      --line2:rgba(140,200,255,.35);
      --glass:rgba(10,20,40,.40);
      --glass2:rgba(10,20,40,.25);
      --glow:rgba(80,190,255,.18);
      --accent:#66d9ff;
      --accent2:#9cffc9;
      --danger:#ff6b6b;
      --shadow:0 16px 40px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
	  --topbar-h: 56px;
	  --pad:14px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 30% 10%, rgba(102,217,255,.12), transparent 55%),
        radial-gradient(900px 700px at 70% 80%, rgba(156,255,201,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
    }

    /* ====== Layout ====== */
    .hud{
      position:relative;
      height:100%;
      display:grid;
      grid-template-columns: 2.0fr 1.0fr;
      gap:14px;
	  padding-left: 14px;
	  padding-right: 14px;
	  padding-top: calc(var(--topbar-h) + var(--pad) + var(--pad));
    }
    @media (max-width: 980px){
      .hud{ grid-template-columns:1fr; grid-template-rows: 1.2fr 0.9fr; overflow:auto; }
      body{ overflow:auto; }
    }

    /* ====== Panels (Glass) ====== */
    .panel{
      position:relative;
      background: linear-gradient(180deg, var(--glass), var(--glass2));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .panel::before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background:
        linear-gradient(90deg, rgba(102,217,255,.10), transparent 40%),
        repeating-linear-gradient(180deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 1px, transparent 6px);
      opacity:.55;
      mix-blend-mode: screen;
    }
    .panel::after{
      content:"";
      position:absolute; inset:-2px;
      pointer-events:none;
      border-radius:var(--r);
      box-shadow: 0 0 0 1px rgba(102,217,255,.10), 0 0 45px var(--glow);
      opacity:.9;
    }

    /* ====== Top HUD bar ====== */
    .topbar{
      position:fixed; left:14px; right:14px; top:14px;
	  top: var(--pad);
      height: var(--topbar-h);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-radius: 16px;
      background: rgba(8,14,28,.45);
      border: 1px solid var(--line);
      z-index: 50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:-0.2px;
    }
    .brand .badge{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent2);
      box-shadow: 0 0 14px rgba(156,255,201,.5);
    }
    .brand span{ opacity:.95; }
    .status{
      display:flex; gap:12px; align-items:center;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    .pill{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
    }
    .btn{
      cursor:pointer;
      user-select:none;
      border:1px solid var(--line2);
      padding:7px 10px;
      border-radius:999px;
      color:var(--ink);
      background: rgba(102,217,255,.08);
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      font-family:var(--mono);
      font-size:12px;
    }
    .btn:hover{ background: rgba(102,217,255,.14); border-color: rgba(102,217,255,.5); }
    .btn:active{ transform: translateY(1px); }

    /* ====== Map panel ====== */
    .mapWrap{ position:relative; height: 100%; min-height: 0; }
    .map{
      position:absolute; inset:0;
      border-radius: var(--r);
    }

    /* Minimap */
    .minimapDock{
      position:absolute;
      right:14px;
      bottom:14px;
      width:240px;
      height:170px;
      border-radius: var(--r2);
      overflow:hidden;
      border:1px solid rgba(102,217,255,.35);
      background: rgba(0,0,0,.2);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      z-index: 999;
    }
    .miniHeader{
      position:absolute;
      top:8px; left:10px;
      z-index: 35;
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      background: rgba(0,0,0,.35);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }
    .minimapHint{
      position:absolute;
      right:10px; top:8px;
      z-index: 35;
      font-family:var(--mono);
      font-size:11px;
      color:var(--ink);
      opacity:.9;
      background: rgba(0,0,0,.35);
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }
    .minimapDock:hover{ border-color: rgba(156,255,201,.55); }

    /* Overlay big minimap */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      z-index: 999;
      padding: 16px;
    }
    .overlay.on{ display:flex; }
    .overlayCard{
      width:min(1100px, 96vw);
      height:min(720px, 90vh);
      border-radius: 18px;
      border: 1px solid rgba(102,217,255,.45);
      background: linear-gradient(180deg, rgba(10,20,40,.6), rgba(10,20,40,.3));
      box-shadow: 0 30px 80px rgba(0,0,0,.6);
      position:relative;
      overflow:hidden;
    }
    .overlayTop{
      position:absolute; top:10px; left:10px; right:10px;
      display:flex; justify-content:space-between; align-items:center;
      z-index: 5;
      gap:10px;
    }
    .overlayTitle{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .overlayClose{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      cursor:pointer;
      font-family:var(--mono);
      color:var(--ink);
    }
    .overlayMap{
      position:absolute; inset:0;
    }

    /* ====== Right log panel ====== */
    .side{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sideHead{
      padding:16px 16px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index: 2;
    }
    .title{
      font-weight:900;
      letter-spacing:-0.4px;
      font-size:18px;
      margin:0;
      display:flex; align-items:center; gap:10px;
    }
    .title i{
      width:10px; height:10px; border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 14px rgba(102,217,255,.55);
      display:inline-block;
    }
    .subtitle{
      margin-top:6px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .filters{
      display:flex; flex-wrap:wrap; gap:8px;
      padding:0 16px 12px;
      position:relative;
      z-index: 2;
    }
    .chip{
      font-family:var(--mono);
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color:var(--ink);
      cursor:pointer;
      user-select:none;
      opacity:.9;
    }
    .chip.on{
      border-color: rgba(156,255,201,.55);
      background: rgba(156,255,201,.10);
    }

    .list{
      padding: 0 12px 12px;
      overflow:auto;
      min-height:0;
      position:relative;
      z-index: 2;
    }
    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      margin: 10px 4px;
      overflow:hidden;
      transition: transform .1s ease, border-color .15s ease, background .15s ease;
      cursor:pointer;
    }
    .card:hover{
      transform: translateY(-1px);
      border-color: rgba(102,217,255,.40);
      background: rgba(0,0,0,.22);
    }
    .card.on{
      border-color: rgba(156,255,201,.55);
      box-shadow: 0 0 0 1px rgba(156,255,201,.12), 0 0 30px rgba(156,255,201,.10);
    }
    .cardBody{ padding:12px 12px 12px; display:flex; gap:12px; }
    .thumb{
      width:84px; height:84px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      flex: 0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-family:var(--mono);
      color:var(--muted);
      font-size:11px;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ flex:1; min-width:0; }
    .line1{
      display:flex; justify-content:space-between; gap:10px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .line2{
      font-size:14px;
      font-weight:700;
      color:var(--ink);
      margin-bottom:8px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tags{
      display:flex; flex-wrap:wrap; gap:6px;
    }
    .tag{
      font-family:var(--mono);
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(102,217,255,.06);
      color: rgba(233,241,255,.92);
    }
    .tag.place{ background: rgba(156,255,201,.08); }
    .tag.fish{ background: rgba(102,217,255,.10); }
    .tag.note{ background: rgba(255,255,255,.06); }

    /* Leaflet UI tweak (transparent) */
    .leaflet-control-container .leaflet-control{
      border-radius: 12px !important;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.14) !important;
      box-shadow: 0 8px 20px rgba(0,0,0,.35) !important;
    }
    .leaflet-bar a{
      background: rgba(0,0,0,.28) !important;
      color: var(--ink) !important;
      border-bottom: 1px solid rgba(255,255,255,.10) !important;
    }
    .leaflet-bar a:hover{ background: rgba(102,217,255,.12) !important; }
	
	/* center crosshair */
	.crosshair{
	  position:absolute;
	  left:50%; top:50%;
	  width:26px; height:26px;
	  transform:translate(-50%,-50%);
	  z-index: 1000;
	  pointer-events:none;
	  filter: drop-shadow(0 0 10px rgba(181,124,255,.35));
	}
	.crosshair::before, .crosshair::after{
	  content:"";
	  position:absolute;
	  left:50%; top:50%;
	  transform:translate(-50%,-50%);
	  background: rgba(181,124,255,.9);
	}
	.crosshair::before{ width:26px; height:2px; }
	.crosshair::after{ width:2px; height:26px; }
	.crosshair .dot{
	  position:absolute; left:50%; top:50%;
	  width:8px; height:8px;
	  transform:translate(-50%,-50%);
	  border-radius:999px;
	  background: rgba(156,255,201,.9);
	  box-shadow: 0 0 18px rgba(181,124,255,.55);
	}
	
	
	.pinInput{
	  border:1px solid rgba(140,200,255,.25);
	  background: rgba(0,0,0,.22);
	  color: var(--ink);
	  border-radius: 12px;
	  padding: 10px 12px;
	  outline:none;
	}
	.pinInput::placeholder{ color: rgba(168,182,214,.75); }
	
	
	/* ====== Mobile: hide date/coords only ====== */
	@media (max-width: 520px){
	  #todayPill,
	  #coordPill{
		display:none !important;
	  }

	  .topbar{
		height: 48px;
		padding: 8px 10px;
		border-radius: 14px;
	  }
	  .status{ gap:8px; }
	  .pill, .btn{ padding:6px 8px; font-size:11px; }
	}

  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="badge"></div>
      <span>STANCE / FishingLog</span>
    </div>
    <div class="status">
      <div class="pill" id="todayPill">DATE</div>
	  <div class="pill" id="coordPill">LAT,LNG</div>
      <div class="pill" id="countPill">LOGS: 0</div>
      <div class="btn" id="btnLocate">LOCATE</div>
    </div>
  </div>

  <div class="hud">
    <!-- LEFT: MAP -->
    <section class="panel mapWrap">
      <div id="mapMain" class="map"></div>
	  <div class="crosshair"><div class="dot"></div></div>

	<!--
      <div class="minimapDock panel" id="minimapDock" title="미니맵 클릭 → 전체 지도">
        <div class="miniHeader">MINIMAP</div>
        <div class="minimapHint">CLICK</div>
        <div id="mapMini" style="position:absolute; inset:0; border-radius:14px;"></div>
      </div>
		-->
		
    </section>

    <!-- RIGHT: LOG LIST -->
    <aside class="panel side">
      <div class="sideHead">
        <div>
          <h2 class="title"><i></i>낚시 로그</h2>
          <div class="subtitle">마커 클릭하면 이쪽에 기록이 뜬다. (한줄 + 사진 + 태그)</div>
        </div>
        <div class="btn" id="btnFocusAll">FOCUS ALL</div>
		<div class="btn" id="btnPinHere">PIN HERE</div>
      </div>

      <div class="filters" id="filters">
        <div class="chip on" data-filter="all">ALL</div>
        <div class="chip" data-filter="붕어">붕어</div>
        <div class="chip" data-filter="블루길">블루길</div>
        <div class="chip" data-filter="빙어">빙어</div>
        <div class="chip" data-filter="채집">채집</div>
      </div>

      <div class="list" id="logList"></div>
    </aside>
  </div>

  <!-- Overlay Big Map -->
  <div class="overlay" id="overlay">
    <div class="overlayCard">
      <div class="overlayTop">
        <div class="overlayTitle">FULL MAP / OVERVIEW</div>
        <div class="overlayClose" id="overlayClose">CLOSE (ESC)</div>
      </div>
      <div id="mapOverlay" class="overlayMap"></div>
    </div>
  </div>
  
  
  <div class="overlay" id="pinModal">
	  <div class="overlayCard" style="height:auto; width:min(520px, 96vw);">
		<div class="overlayTop">
		  <div class="overlayTitle">NEW LOG (PIN HERE)</div>
		  <div class="overlayClose" id="pinClose">CLOSE (ESC)</div>
		</div>

		<div style="padding:58px 14px 14px;">
		  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px;">
			<div class="pill" id="pinLatLng">LAT,LNG</div>
			<input id="pinPlace" placeholder="장소 (예: 탄금호)" style="flex:1; min-width:180px;"
			  class="pinInput">
		  </div>

		  <input id="pinTitle" placeholder="한줄 메모 (예: 새벽 물안개, 입질 2번)" class="pinInput" style="width:100%; margin-bottom:10px;">

		  <input id="pinTags" placeholder="태그 (쉼표로) 예: 붕어,초겨울,바람" class="pinInput" style="width:100%; margin-bottom:10px;">

		  <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
			<input id="pinPhoto" type="file" accept="image/*" class="pinInput" style="flex:1;">
		  </div>

		  <div style="display:flex; gap:10px; justify-content:flex-end;">
			<div class="btn" id="pinSave">SAVE</div>
		  </div>
		</div>
	  </div>
	</div>
  
  

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ====== Demo data (네가 혼자 쓰는 구조: json만 바꾸면 됨) ======
    // 사진은 로컬/서버 URL 아무거나 가능
	
	let LOGS = [];
	
	async function loadFromServer(){
	  try{
		const res = await fetch("https://mrdindoin.ddns.net/stsf/api/logs", {
		  cache: "no-store"
		});

		if(!res.ok){
			console.log("!res");
		  throw new Error("HTTP " + res.status);
		}

		LOGS = await res.json();
		  console.log("",LOGS);
		render();
		fitAll(LOGS);

	  }catch(err){
		console.error("LOG LOAD FAIL:", err);
		alert("로그를 불러오지 못했습니다");
	  }
	}  

    // ====== UI helpers ======
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

    function fmtToday(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    $("#todayPill").textContent = fmtToday();

    // ====== Leaflet Maps ======
    const start = { lat: 36.99, lng: 127.92, zoom: 12 };

    const mapMain = L.map("mapMain", { zoomControl:true }).setView([start.lat, start.lng], start.zoom);
    // const mapMini = L.map("mapMini", { zoomControl:false, attributionControl:false, dragging:true, scrollWheelZoom:false, doubleClickZoom:false, boxZoom:false, keyboard:false, tap:false }).setView([start.lat, start.lng], 11);
    const mapOverlay = L.map("mapOverlay", { zoomControl:true }).setView([start.lat, start.lng], 11);

    // Tiles (OSM)
    const tile = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
    const attr = "&copy; OpenStreetMap contributors";
    L.tileLayer(tile, { attribution: attr, maxZoom: 19 }).addTo(mapMain);
    // L.tileLayer(tile, { maxZoom: 19 }).addTo(mapMini);
    L.tileLayer(tile, { attribution: attr, maxZoom: 19 }).addTo(mapOverlay);

    // ====== Markers store ======
    const markersMain = new Map();
    // const markersMini = new Map();
    const markersOverlay = new Map();

    function makeIcon(kind){
      // 간단 글로우 느낌 점 아이콘
      const color = kind === "붕어" ? "#9cffc9" :
                    kind === "블루길" ? "#66d9ff" :
                    kind === "빙어" ? "#ffd166" : "#e9f1ff";
      return L.divIcon({
        className: "",
        html: `
          <div style="
            width:14px;height:14px;border-radius:999px;
            background:${color};
            box-shadow: 0 0 0 3px rgba(0,0,0,.35), 0 0 18px ${color}55;
            border:1px solid rgba(255,255,255,.25);
          "></div>
        `,
        iconSize: [14,14],
        iconAnchor: [7,7]
      });
    }

	function toNum(v){
	  const n = Number(v);
	  return Number.isFinite(n) ? n : null;
	}
	  
    function addLogMarker(log){
	  const lat = toNum(log.lat);
	  const lng = toNum(log.lng);
	
	  if(lat === null || lng === null){
	    console.warn("SKIP marker (bad lat/lng):", log);
	    return;
	  }
      const primary = (log.fish && log.fish[0]) ? log.fish[0] : "기록";
      const icon = makeIcon(primary);

      const m1 = L.marker([log.lat, log.lng], { icon }).addTo(mapMain);
      // const m2 = L.marker([log.lat, log.lng], { icon }).addTo(mapMini);
      const m3 = L.marker([log.lat, log.lng], { icon }).addTo(mapOverlay);

      const tip = `<b>${log.title}</b><br>${log.place}<br><span style="opacity:.7">${log.date}</span>`;
      m1.bindTooltip(tip, { direction:"top", opacity:0.95 });
      m3.bindTooltip(tip, { direction:"top", opacity:0.95 });

      const onClick = ()=> selectLog(log.id, true);
      m1.on("click", onClick);
      m2.on("click", onClick);
      m3.on("click", onClick);

      markersMain.set(log.id, m1);
      // markersMini.set(log.id, m2);
      markersOverlay.set(log.id, m3);
    }

    function clearMarkers(){
      for (const m of markersMain.values()) mapMain.removeLayer(m);
      // for (const m of markersMini.values()) mapMini.removeLayer(m);
      for (const m of markersOverlay.values()) mapOverlay.removeLayer(m);
      // markersMain.clear(); markersMini.clear(); markersOverlay.clear();
    }

    function fitAll(logs){
      if(!logs.length) return;
      const bounds = L.latLngBounds(logs.map(x=>[x.lat,x.lng]));
      mapMain.fitBounds(bounds, { padding:[40,40] });
      // mapMini.fitBounds(bounds, { padding:[20,20] });
      mapOverlay.fitBounds(bounds, { padding:[40,40] });
    }

    // ====== Render list ======
    let activeFilter = "all";
    let selectedId = null;

    function matchesFilter(log){
      if(activeFilter === "all") return true;
      if(log.fish?.includes(activeFilter)) return true;
      if(log.tags?.includes(activeFilter)) return true;
      if(log.place?.includes(activeFilter)) return true;
      if(log.title?.includes(activeFilter)) return true;
      return false;
    }

    function render(){
      const filtered = LOGS.filter(matchesFilter);
      $("#countPill").textContent = `LOGS: ${filtered.length}`;

      // markers
      clearMarkers();
      filtered.forEach(addLogMarker);

      // list
      const list = $("#logList");
      list.innerHTML = "";
      filtered
        .slice()
        .sort((a,b)=> (a.date < b.date ? 1 : -1))
        .forEach(log=>{
          const card = document.createElement("div");
          card.className = "card" + (log.id === selectedId ? " on" : "");
          card.dataset.id = log.id;

          const tags = []
            .concat([{t: log.place, cls:"place"}])
            .concat((log.fish||[]).map(f=>({t:f, cls:"fish"})))
            .concat((log.tags||[]).slice(0,4).map(t=>({t, cls:"note"})));

          card.innerHTML = `
            <div class="cardBody">
              <div class="thumb">
                ${log.photo ? `<img src="${log.photo}" alt="">` : `NO PHOTO`}
              </div>
              <div class="meta">
                <div class="line1">
                  <span>${log.date}</span>
                  <span style="opacity:.85">${log.id}</span>
                </div>
                <div class="line2">${escapeHtml(log.title)}</div>
                <div class="tags">
                  ${tags.map(x=>`<span class="tag ${x.cls}">#${escapeHtml(x.t)}</span>`).join("")}
                </div>
              </div>
            </div>
          `;

          card.addEventListener("click", ()=> selectLog(log.id, true));
          list.appendChild(card);
        });

      // keep selection if filtered out
      if(selectedId && !filtered.some(x=>x.id===selectedId)){
        selectedId = null;
      }
    }
	
	
	function clearSelection(){
	  selectedId = null;
	  // 카드 하이라이트 제거
	  $$(".card").forEach(c=> c.classList.remove("on"));
	  // 마커 툴팁 닫기
	  for (const m of markersMain.values()) m.closeTooltip();
	}
	
	mapMain.on("click", clearSelection);
	
	window.addEventListener("keydown", (e)=>{
	  if(e.key === "Escape") clearSelection();
	});

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function selectLog(id, pan){
      selectedId = id;
      // highlight card
      $$(".card").forEach(c=> c.classList.toggle("on", c.dataset.id===id));

      const log = LOGS.find(x=>x.id===id);
      if(!log) return;

      // pan maps
      if(pan){
        mapMain.flyTo([log.lat, log.lng], Math.max(mapMain.getZoom(), 14), { duration: 0.6 });
        // mapMini.flyTo([log.lat, log.lng], Math.max(mapMini.getZoom(), 12), { duration: 0.4 });
        mapOverlay.flyTo([log.lat, log.lng], Math.max(mapOverlay.getZoom(), 13), { duration: 0.6 });
      }

      // open tooltip (main)
      const m = markersMain.get(id);
      if(m) m.openTooltip();

      // scroll list to card
      const card = $(`.card[data-id="${CSS.escape(id)}"]`);
      if(card) card.scrollIntoView({ block:"nearest", behavior:"smooth" });
    }

    // ====== Filter chips ======
    $$("#filters .chip").forEach(chip=>{
      chip.addEventListener("click", ()=>{
        $$("#filters .chip").forEach(c=>c.classList.remove("on"));
        chip.classList.add("on");
        activeFilter = chip.dataset.filter;
        render();
      });
    });

	
	// ======= crosshair =========
	function setCoordPill(latlng){
	  $("#coordPill").textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
	}

	// 지도 움직일 때마다 “중앙 좌표” 표시
	mapMain.on("move", ()=>{
	  setCoordPill(mapMain.getCenter());
	});
	setCoordPill(mapMain.getCenter());


	const pinModal = $("#pinModal");
	let pinPoint = null;

	function openPinModal(lat, lng){
	  pinPoint = { lat, lng };
	  $("#pinLatLng").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
	  $("#pinTitle").value = "";
	  $("#pinTags").value = "";
	  $("#pinPlace").value = "";
	  $("#pinPhoto").value = "";
	  pinModal.classList.add("on");
	}

	function closePinModal(){
	  pinModal.classList.remove("on");
	}

	$("#btnPinHere").addEventListener("click", ()=>{
	  const c = mapMain.getCenter();
	  openPinModal(c.lat, c.lng);
	});

	$("#pinClose").addEventListener("click", closePinModal);
	pinModal.addEventListener("click", (e)=>{ if(e.target === pinModal) closePinModal(); });

	window.addEventListener("keydown", (e)=>{
	  if(e.key === "Escape"){
		closePinModal();
		overlay.classList.remove("on"); // 기존 전체지도 overlay 닫기(원하면)
	  }
	});

	// 서버 저장 (Flask)
	async function savePinToServer(){
	  if(!pinPoint) return;

	  const title = $("#pinTitle").value.trim();
	  if(!title){ alert("한줄 메모는 필수!"); return; }

	  const place = $("#pinPlace").value.trim();
	  const tagsRaw = $("#pinTags").value.trim();
	  const tags = tagsRaw ? tagsRaw.split(",").map(s=>s.trim()).filter(Boolean) : [];

	  const fd = new FormData();
	  fd.append("title", title);
	  fd.append("place", place);
	  fd.append("lat", String(pinPoint.lat));
	  fd.append("lng", String(pinPoint.lng));
	  fd.append("tags", JSON.stringify(tags)); // 서버에서 json.loads
	  const file = $("#pinPhoto").files?.[0];
	  if(file) fd.append("photo", file);

	  const res = await fetch("https://mrdindoin.ddns.net/stsf/api/logs", { method:"POST", body: fd });
	  if(!res.ok){
		const t = await res.text();
		throw new Error(t || "save failed");
	  }
	  return await res.json();
	}

	$("#pinSave").addEventListener("click", async ()=>{
	  try{
		const saved = await savePinToServer();

		// UI 반영: 서버가 준 log를 LOGS에 넣고 렌더
		LOGS.push(saved);
		render();
		selectLog(saved.id, true);
		closePinModal();
	  }catch(err){
		alert("저장 실패: " + err.message);
	  }
  	});
  
  
	
	

    // ====== Controls ======
    $("#btnFocusAll").addEventListener("click", ()=>{
      const filtered = LOGS.filter(matchesFilter);
      fitAll(filtered);
    });

    $("#btnLocate").addEventListener("click", ()=>{
      if(!navigator.geolocation){
        alert("이 브라우저는 위치를 지원 안함");
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        mapMain.flyTo([lat,lng], 15, {duration:0.8});
        // mapMini.flyTo([lat,lng], 13, {duration:0.6});
        mapOverlay.flyTo([lat,lng], 14, {duration:0.8});

        // 현재 위치 표시(임시)
        L.circleMarker([lat,lng], {
          radius: 8,
          color: "#66d9ff",
          weight: 2,
          fillColor: "#66d9ff",
          fillOpacity: 0.25
        }).addTo(mapMain).bindTooltip("YOU", {direction:"top", opacity:0.9}).openTooltip();
      }, (err)=>{
        alert("위치 권한이 필요함: " + err.message);
      }, { enableHighAccuracy:true, timeout:8000 });
    });


    // ====== Init ======
    loadFromServer();
	render();
    fitAll(LOGS);
	
  </script>
</body>
</html>
