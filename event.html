<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3x3 ë’¤ì§‘ê¸° â€” ìƒí’ˆ ì¶”ì²¨</title>
  <style>
    :root{
      --bg:#0f172a; --panel:#0b1220; --line:#263043; --ink:#dbeafe; --mut:#90b8ff;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#0b1020,#0f172a 40%,#0a1025); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    header,footer{max-width:820px; margin:24px auto; padding:0 14px}
    h1{margin:0 0 6px; font-size:clamp(22px,4vw,30px)}
    p{margin:0; color:var(--mut)}

    .wrap{max-width:820px; margin:12px auto 36px; padding:0 14px;}
    .card{background:rgba(10,16,35,.65); border:1px solid var(--line); border-radius:16px; padding:14px}

    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:.3rem .6rem; border:1px solid var(--line); border-radius:999px; background:#0b1428; color:#cfe3ff; font-size:12px}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:12px}
    .tile{position:relative; width:100%; aspect-ratio:1/1; perspective:800px}
    .btn{position:absolute; inset:0; border-radius:14px; border:1px solid var(--line); background:#0c1730; color:#e8f1ff; cursor:pointer; font-weight:700; font-size:20px}
    .btn:disabled{opacity:.55; cursor:not-allowed}

    /* flip animation */
    .face{position:absolute; inset:0; display:grid; place-items:center; backface-visibility:hidden; border-radius:14px; border:1px solid var(--line)}
    .front{background:#0c1730}
    .back{background:#0c1d3a; transform:rotateY(180deg)}
    .flipping .front{transform:rotateY(180deg)}
    .flipping .back{transform:rotateY(360deg)}
    .face, .flipping .face{transition:transform 0.6s cubic-bezier(.2,.7,.2,1)}

    .status{display:flex; justify-content:space-between; align-items:center; gap:10px}
    input[type=email]{width:240px; max-width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#0a1225; color:#e5edf9}
    button.small{padding:8px 12px; border-radius:10px; border:1px solid var(--line); background:#0c1730; color:#e5edf9; cursor:pointer}

    .toast{position:fixed; left:50%; top:16px; transform:translateX(-50%); background:#0d1a33; border:1px solid #2a3a58; padding:10px 14px; border-radius:12px; color:#d7e7ff; display:none; z-index:50}

    /* modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(6,10,20,.6)}
    .modal .box{background:#071327; border:1px solid var(--line); border-radius:16px; padding:18px; width:min(92vw,420px); text-align:center}
    .modal .box h2{margin:0 0 8px}
    .modal .box p{margin:0 0 14px; color:var(--mut)}
    .modal .box .ok{border:1px solid var(--line); background:#0c1730; color:#e5edf9; padding:10px 14px; border-radius:12px; cursor:pointer}

    footer{color:#8fb5ff; font-size:13px}
    a{color:#9cc7ff}
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9382191250873184"
     crossorigin="anonymous"></script>
</head>
<body>
  <header style="display:flex;justify-content:center;align-items:center;gap:16px;padding:16px;">
  <input id="emailInput" type="email" placeholder="ì´ë©”ì¼ ì…ë ¥" 
    style="padding:10px 14px;border-radius:10px;border:1px solid #333;
           background:#111;color:#eee;font-size:16px;"/>
  <div id="remainingCount" 
    style="font-size:64px;font-weight:900;
           background:linear-gradient(180deg,#FFD700,#FFB700,#FFA500);
           -webkit-background-clip:text;
           -webkit-text-fill-color:transparent;
           text-shadow:0 0 10px rgba(255,215,0,0.3);
           min-width:80px;text-align:center;">
    0
  </div>
</header>

  <div class="wrap">
    <!-- ìƒíƒœ/ì´ë©”ì¼ -->
    <div class="card">
      <div class="status">
        <div class="row">
          <span class="pill" id="liveState">ìƒíƒœ: <b>í™•ì¸ ì¤‘â€¦</b></span>
          <span class="pill">ë² íƒ€ v0.1</span>
        </div>
        <div class="row">
          <input type="email" id="email" placeholder="you@example.com" autocomplete="email" />
          <button class="small" id="saveEmail">ì €ì¥</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px; color:var(--mut); font-size:13px">
        <span>* ë’¤ì§‘ê¸°ëŠ” <b>í•œ ë²ˆì— í•œ ì¹¸</b>ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì•½ 2ì´ˆ)</span>
        <span id="invInfo" style="margin-left:auto"></span>
      </div>
    </div>

    <!-- 3x3 ê·¸ë¦¬ë“œ -->
    <div class="card">
      <div class="grid" id="grid"></div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div>ì´ë ¥</div>
        <button class="small" id="clearLocal">ë¡œì»¬ ì´ˆê¸°í™”</button>
      </div>
      <pre id="log" style="white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; background:#0a1326; border:1px solid #263043; padding:10px; border-radius:10px; max-height:180px; overflow:auto; margin-top:10px"></pre>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ëª¨ë‹¬: ê²°ê³¼ -->
  <div class="modal" id="resultModal">
    <div class="box">
      <h2 id="resultTitle">ê²°ê³¼</h2>
      <p id="resultDesc"></p>
      <button class="ok" id="closeModal">í™•ì¸</button>
    </div>
  </div>

  <footer>
    <div>Â© 2025 Stance / LocalFlow â€” ë°ëª¨ìš©. ì‹¤ì œ ë‹¹ì²¨/ì†Œì§„ ë¡œì§ì€ ì„œë²„ê°€ ê²°ì •í•©ë‹ˆë‹¤.</div>
  </footer>

<script>
// ===== CONFIG: ì‹¤ì œ ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½ =====
const API = {
  status: "https://mrdindoin.ddns.net/flip/status", // GET â†’ {active:boolean, inventory:number, total:number, ratio:number}
  flip:   "https://mrdindoin.ddns.net/flip/flip"    // POST {email, cell, t, nonce?} â†’ {win:boolean, code?:string, inventory:number}
};
const FLIP_DELAY_MS = 2000; // ì•½ 2ì´ˆ

// ===== Utils =====
const $ = (s)=>document.querySelector(s);
const logBox = $('#log');
const toastEl = $('#toast');
function log(msg){ const t=new Date().toLocaleString(); logBox.textContent = `[${t}] ${msg}\n` + logBox.textContent; }
function toast(msg,ms=1600){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',ms); }
function getLocal(k,def=null){ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch(e){return def;} }
function setLocal(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

// ===== Email (ì„ íƒ) =====
const emailInput = $('#email');
$('#saveEmail').addEventListener('click',()=>{
  const v=(emailInput.value||'').trim();
  if(!v || !v.includes('@')){ toast('ì´ë©”ì¼ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”'); return; }
  setLocal('flip_email', v); toast('ì´ë©”ì¼ ì €ì¥');
});
(function initEmail(){ const v=getLocal('flip_email',''); if(v) emailInput.value=v; })();

// ===== ìƒíƒœ ë³´ë“œ =====
const liveState = $('#liveState');
const invInfo = $('#invInfo');
let lastStatus = {active:false, inventory:0, total:0, ratio:0};

async function fetchStatus(){
  try{
    const res = await fetch(API.status, {cache:'no-store'});
    if(!res.ok) throw new Error('status '+res.status);
    const d = await res.json();
    lastStatus = {
      active: !!d.active,
      inventory: Number(d.inventory||0),
      total: Number(d.total||0),
      ratio: Number(d.ratio||0)
    };
  }catch(e){
    // ë°ëª¨ ëª¨ë“œ: ì„œë²„ ì—†ì„ ë•Œ â€” ë¹„í™œì„± & ì¬ê³  0
    lastStatus = {active:false, inventory:0, total:0, ratio:0};
  }
  renderStatus();
}

function renderStatus(){
  const s = lastStatus.active ? 'íŒë§¤ì¤‘' : 'ëŒ€ê¸°ì¤‘';
  const color = lastStatus.active ? 'var(--ok)' : 'var(--warn)';
  liveState.innerHTML = `ìƒíƒœ: <b style="color:${color}">${s}</b>`;
  invInfo.textContent = (lastStatus.total>0) ? `ê°€ëŠ¥ ìˆ˜ëŸ‰ ${lastStatus.inventory}` : '';
}

setInterval(fetchStatus, 5000);
fetchStatus();

// ===== 3x3 ê·¸ë¦¬ë“œ =====
const grid = $('#grid');
let busy = false; // í•œ ë²ˆì— í•œ ì¹¸ë§Œ

function makeTile(idx){
  const tile = document.createElement('div');
  tile.className = 'tile';
  tile.innerHTML = `
    <div class="face front"><button class="btn">ë’¤ì§‘ê¸°</button></div>
    <div class="face back"><div style="font-size:26px">â€¦</div></div>
  `;
  const front = tile.querySelector('.front');
  const back = tile.querySelector('.back');
  const btn = tile.querySelector('.btn');

  btn.addEventListener('click', async ()=>{
    if(busy) return; busy = true;
    // ë¹„í™œì„±í™”: í•œ ë²ˆì— í•œ ì¹¸
    grid.querySelectorAll('.btn').forEach(b=>b.disabled=true);

    // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    tile.classList.add('flipping');
    back.innerHTML = '<div style="font-size:26px">â³</div>';

    // 2ì´ˆ ì§€ì—°
    await new Promise(r=>setTimeout(r, FLIP_DELAY_MS));

    // ì„œë²„ì— ê²°ê³¼ ìš”ì²­
    const payload = {
      email: (emailInput.value||'').trim() || null,
      cell: idx,
      t: Date.now(),
    };

    let result = {win:false, code:null, inventory:0};
    try{
      const res = await fetch(API.flip, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if(!res.ok) throw new Error('flip '+res.status);
      result = await res.json();
    }catch(e){
      // ë°ëª¨ ëª¨ë“œ: ì„œë²„ ì—†ìœ¼ë©´ í•­ìƒ ê½ (ì¬ê³  0)
      result = {win:false, code:null, inventory:0};
    }

    // ê²°ê³¼ í‘œì‹œ
    if(result.win){
      back.innerHTML = '<div style="font-size:28px">ğŸ‰ ë‹¹ì²¨!</div>';
      showModal('ë‹¹ì²¨!', 'í˜„ì¥ì—ì„œ êµí™˜í•˜ê±°ë‚˜, ì½”ë“œ ì…ë ¥ìœ¼ë¡œ êµí™˜í•˜ì„¸ìš”.' + (result.code? `\nì½”ë“œ: ${result.code}`:''));
      log('WIN cell '+idx + (result.code? ' code '+result.code : ''));
    } else {
      back.innerHTML = '<div style="font-size:24px; opacity:.9">ê½</div>';
      log('LOSE cell '+idx);
    }

    // ìƒíƒœ ë¦¬í”„ë ˆì‹œ
    fetchStatus();

    // ì ê¸ˆ í•´ì œ + ë²„íŠ¼ ì›ìƒë³µêµ¬
    setTimeout(()=>{
      tile.classList.remove('flipping'); // ë‹¤ìŒ ì‹œë„ ìœ„í•´ ì›ìƒíƒœ (ì•ë©´)
      grid.querySelectorAll('.btn').forEach(b=>b.disabled=false);
      busy = false;
    }, 400); // í”Œë¦½ ë³µê·€ ì• ë‹ˆë©”ì´ì…˜ ì•½ê°„ ê¸°ë‹¤ë¦¼
  });

  return tile;
}

function buildGrid(){
  grid.innerHTML='';
  for(let i=0;i<9;i++) grid.appendChild(makeTile(i));
}
buildGrid();

// ===== ëª¨ë‹¬ =====
const modal = $('#resultModal');
const titleEl = $('#resultTitle');
const descEl = $('#resultDesc');
$('#closeModal').addEventListener('click', ()=> modal.style.display='none');
function showModal(title, desc){ titleEl.textContent=title; descEl.textContent=desc; modal.style.display='grid'; }

// ===== ë¡œì»¬ ì´ˆê¸°í™” =====
$('#clearLocal').addEventListener('click',()=>{ localStorage.clear(); toast('ë¡œì»¬ ì´ˆê¸°í™” ì™„ë£Œ'); });

</script>
</body>
</html>
