<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GoalBoard — Minimal Timeline</title>
<style>
  :root{
    --bg:#ffffff; --fg:#111; --muted:#777; --accent:#0a84ff;
    --ok:#111; --warn:#c95; --done:#2a2; --line:#e9e9e9;
    --gap:16px; --radius:10px; --shadow:0 2px 10px rgba(0,0,0,.06);
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f1115; --fg:#ececec; --muted:#a5a5a5; --accent:#64b5ff; --ok:#ececec; --warn:#e0b57b; --done:#7ee787; --line:#222; }
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, sans-serif;
  }

  /* Header */
  header{
    position:sticky; top:0; z-index:10;
    backdrop-filter:saturate(150%) blur(8px);
    background:color-mix(in srgb, var(--bg) 86%, transparent);
    border-bottom:1px solid var(--line);
  }
  .wrap{ max-width:980px; margin:0 auto; padding:10px 14px }
  .row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  .grow{ flex:1 1 auto }
  h1{ margin:0; font-size:16px; font-weight:700 }
  .sub{ color:var(--muted); font-size:13px }

  /* Top controls */
  .controls{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  button, .btn{
    border:1px solid var(--line); background:transparent; color:var(--fg);
    padding:6px 10px; border-radius:8px; cursor:pointer; box-shadow:var(--shadow);
  }
  button:hover{ border-color:color-mix(in srgb, var(--fg) 20%, var(--line)) }
  .pill{ padding:4px 8px; border-radius:999px; border:1px solid var(--line); font-size:12px; color:var(--muted) }
  .dot{ display:inline-block; width:8px; height:8px; border-radius:50%; background:var(--muted); vertical-align:middle; margin-right:6px; }
  .dot.current{ background:var(--accent) }
  .dot.issue{ background:var(--warn) }
  .dot.done{ background:var(--done) }

  /* Goal switcher */
  .goalbar{ display:flex; align-items:center; gap:8px; overflow:auto; padding:8px 0 }
  .goalchip{
    white-space:nowrap; padding:6px 10px; border-radius:999px; border:1px solid var(--line);
    cursor:pointer; background:transparent; color:var(--fg);
  }
  .goalchip[aria-current="true"]{ border-color:var(--accent) }

  /* Timeline */
  main{ max-width:980px; margin:0 auto; padding:14px }
  .summary{
    border:1px solid var(--line); border-radius:12px; padding:10px 12px; margin-bottom:12px;
    display:flex; gap:14px; flex-wrap:wrap; align-items:center;
  }
  .summary b{ font-weight:700 }
  .summary small{ color:var(--muted) }

  .timeline{
    position:relative; padding-left:22px; border-left:2px solid var(--line);
  }
  .item{ position:relative; margin:14px 0; padding-left:8px }
  .item .bullet{
    position:absolute; left:-30px; top:.3em; width:14px; height:14px;
    border-radius:50%; border:2px solid var(--line); background:var(--bg);
  }
  .item.current .bullet{ border-color:var(--accent); box-shadow:0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent) inset }
  .item.done .bullet{ background:var(--done); border-color:var(--done) }
  .item.issue .bullet{ background:var(--warn); border-color:var(--warn) }
  .item .title{ font-weight:600 }
  .item .meta{ color:var(--muted); font-size:12px }

  /* Horizontal mode */
  .timeline.h{
    border-left:none; padding:0; overflow:auto; white-space:nowrap;
    border-top:2px solid var(--line);
  }
  .timeline.h .item{
    display:inline-block; vertical-align:top; width:240px; margin:12px 10px; padding-left:0;
    border-top:0; border-left:0; border-right:0;
  }
  .timeline.h .bullet{ left:0; top:-22px }
  .timeline.h .date{ display:block; color:var(--muted); font-size:12px; margin-bottom:4px }

  /* Quick add */
  .adder{
    display:flex; gap:8px; margin-top:14px; flex-wrap:wrap;
    border:1px dashed var(--line); border-radius:10px; padding:10px;
  }
  input[type="text"]{
    flex:1 1 240px; padding:10px 12px; border-radius:8px; border:1px solid var(--line);
    background:transparent; color:var(--fg);
  }

  /* Footer info */
  footer{ color:var(--muted); font-size:12px; padding:20px 14px; text-align:center }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="grow">
          <h1 id="hdr-title">GoalBoard</h1>
          <div class="sub" id="hdr-sub"></div>
        </div>
        <div class="controls">
          <button id="btn-prev" title="이전 목표 (←)">←</button>
          <div class="pill" id="goal-index">1/1</div>
          <button id="btn-next" title="다음 목표 (→)">→</button>
          <button id="btn-orient" title="세로/가로 전환 (V)">세로</button>
          <button id="btn-export" title="JSON 내보내기">내보내기</button>
          <label class="btn" title="JSON 가져오기">
            가져오기 <input id="file-import" type="file" accept="application/json" hidden>
          </label>
        </div>
      </div>
      <div class="goalbar" id="goalbar" aria-label="목표 전환 바"></div>
    </div>
  </header>

  <main>
    <div class="summary" id="summary"></div>
    <div id="timeline" class="timeline" aria-live="polite"></div>

    <div class="adder">
      <input id="quickline" type="text" placeholder="YYYY-MM-DD [type] title #status :: note (예: 2025-09-10 [event] 오븐 테스트(120°C) #progress :: K센서 로깅)" />
      <button id="btn-add">+ 한 문장</button>
      <button id="btn-tts" title="아침 브리핑 말하기">브리핑</button>
      <button id="btn-newGoal" title="새 목표 추가">+ 목표</button>
    </div>
  </main>

  <footer>한 문장씩 전진하는 미니멀 타임라인 — 오프라인 우선 · 로컬 저장</footer>

<script>
/* -------------------------
   Minimal GoalBoard State
------------------------- */
const LS_KEY = 'goalboard_state_v1';

const seed = {
  goals: [
    {
      id: 'shaft-v1',
      title: 'Carbon Shaft v1',
      targetDate: '2025-10-01',
      timeline: [
        {date:'2025-09-01',type:'milestone',title:'설계 확정',status:'done'},
        {date:'2025-09-05',type:'event',title:'맨드렐 주문',status:'done'},
        {date:'2025-09-07',type:'issue',title:'수축테이프 스펙 재확인',status:'open',note:'폭/신율 점검'},
        {date:'2025-09-10',type:'event',title:'오븐 테스트(120°C)',status:'progress'}
      ]
    },
    { id:'smartfarm', title:'Smart Farm 모듈', targetDate:'2026-03-01', timeline:[] }
  ],
  ui: { orientation:'vertical', activeGoalId:'shaft-v1' }
};

let state = load() || seed;
save();

/* -------------------------
   Utils
------------------------- */
function ymd(d){ const x = (d instanceof Date)? d : new Date(d); return x.toISOString().slice(0,10); }
function todayStr(){ return ymd(new Date()); }
function fmtKDate(d){
  const date = (d instanceof Date)? d : new Date(d);
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const dd= String(date.getDate()).padStart(2,'0');
  return `${y}.${m}.${dd}`;
}
function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || ''); }catch{ return null; } }
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function activeGoalIndex(){ return Math.max(0, state.goals.findIndex(g=>g.id===state.ui.activeGoalId)); }
function setActiveByIndex(i){
  const clamped = (i<0? 0 : (i>=state.goals.length? state.goals.length-1 : i));
  state.ui.activeGoalId = state.goals[clamped].id; save(); render();
}

/* parse line: "YYYY-MM-DD [type] title #status :: note" */
function parseLine(line){
  const obj = {date: todayStr(), type:'event', title:'', status:'planned'};
  if(!line || !line.trim()) return null;
  let s = line.trim();

  // date
  const mDate = s.match(/^(\d{4}-\d{2}-\d{2})\s+/);
  if(mDate){ obj.date = mDate[1]; s = s.slice(mDate[0].length); }

  // [type]
  const mType = s.match(/^\[([a-zA-Z]+)\]\s*/);
  if(mType){ obj.type = mType[1].toLowerCase(); s = s.slice(mType[0].length); }

  // #status and ::note
  let note = '';
  const noteIdx = s.indexOf('::');
  if(noteIdx>=0){ note = s.slice(noteIdx+2).trim(); s = s.slice(0, noteIdx).trim(); }

  let status = obj.status;
  const mStatus = s.match(/#([a-zA-Z]+)/);
  if(mStatus){ status = mStatus[1].toLowerCase(); s = s.replace(mStatus[0],'').trim(); }

  const title = s.trim();
  if(!title) return null;

  obj.title = title;
  obj.status = status;
  if(note) obj.note = note;
  return obj;
}

function deriveCurrentNextIssues(tl){
  const t = todayStr();
  const byDate = [...tl].sort((a,b)=> a.date.localeCompare(b.date));
  const openIssues = byDate.filter(n=> n.type==='issue' && (n.status==='open' || !n.status));
  const inProgressToday = byDate.find(n=> n.date===t && n.status==='progress');
  const recentProgress = [...byDate].reverse().find(n=> n.status==='progress');
  const futurePlanned = byDate.find(n=> n.date>=t && ((n.status||'planned')==='planned' || /milestone|goal/.test(n.type)));

  const current = inProgressToday || recentProgress || futurePlanned || byDate[byDate.length-1] || null;
  const next = futurePlanned || null;
  return { current, next, issues: openIssues.slice(0,3) };
}

/* -------------------------
   Render
------------------------- */
function render(){
  const idx = activeGoalIndex();
  const goal = state.goals[idx];
  const hdrTitle = document.getElementById('hdr-title');
  const hdrSub = document.getElementById('hdr-sub');
  const goalbar = document.getElementById('goalbar');
  const goalIndex = document.getElementById('goal-index');
  const timelineEl = document.getElementById('timeline');
  const summary = document.getElementById('summary');

  hdrTitle.textContent = `${goal.title}`;
  hdrSub.textContent = `${fmtKDate(new Date())} • 목표 완료 지점: ${goal.targetDate || '-'}`;

  // goalbar
  goalbar.innerHTML = '';
  state.goals.forEach((g,i)=>{
    const btn = document.createElement('button');
    btn.className = 'goalchip';
    btn.textContent = g.title;
    btn.setAttribute('aria-current', String(i===idx));
    btn.onclick = ()=>{ setActiveByIndex(i); };
    goalbar.appendChild(btn);
  });
  goalIndex.textContent = `${idx+1}/${state.goals.length}`;

  // summary
  const {current, next, issues} = deriveCurrentNextIssues(goal.timeline);
  summary.innerHTML = `
    <div><span class="dot current"></span><b>현재</b> ${current? (current.title + ' ' + `<small>(${current.date})</small>`) : '-'}</div>
    <div><span class="dot"></span><b>다음</b> ${next? (next.title + ' ' + `<small>(${next.date})</small>`) : '-'}</div>
    <div><span class="dot issue"></span><b>이슈</b> ${issues.length? issues.map(x=>x.title).join(', ') : '없음'}</div>
  `;

  // timeline
  const tl = [...goal.timeline].sort((a,b)=> a.date.localeCompare(b.date));
  timelineEl.className = 'timeline' + (state.ui.orientation==='horizontal' ? ' h' : '');
  timelineEl.innerHTML = tl.map(n=>{
    const cls = [
      'item',
      (n.status==='done' ? 'done' : ''),
      (n.status==='progress' ? 'current' : ''),
      (n.type==='issue' && (n.status!=='done') ? 'issue' : '')
    ].join(' ');
    const meta = [n.date, n.type, n.status].filter(Boolean).join(' · ');
    return `
      <div class="${cls}">
        <div class="bullet"></div>
        <div class="date">${fmtKDate(n.date)}</div>
        <div class="title">${escapeHTML(n.title)}</div>
        <div class="meta">${escapeHTML(meta)}${n.note? ' · ' + escapeHTML(n.note):''}</div>
      </div>
    `;
  }).join('') || `<div class="sub">아직 기록이 없습니다. 아래에 한 문장을 추가해보세요.</div>`;

  // orient button label
  document.getElementById('btn-orient').textContent = (state.ui.orientation==='horizontal' ? '가로' : '세로');
}

function escapeHTML(s){ return String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* -------------------------
   Events / Controls
------------------------- */
document.getElementById('btn-prev').onclick = ()=> setActiveByIndex(activeGoalIndex()-1);
document.getElementById('btn-next').onclick = ()=> setActiveByIndex(activeGoalIndex()+1);

document.getElementById('btn-orient').onclick = ()=>{
  state.ui.orientation = (state.ui.orientation==='vertical' ? 'horizontal' : 'vertical');
  save(); render();
};

document.getElementById('btn-add').onclick = ()=>{
  const input = document.getElementById('quickline');
  const node = parseLine(input.value);
  if(!node){ alert('형식: YYYY-MM-DD [type] title #status :: note'); return; }
  const g = state.goals[activeGoalIndex()];
  g.timeline.push(node);
  save(); input.value=''; render();
};

document.getElementById('btn-newGoal').onclick = ()=>{
  const title = prompt('새 목표 이름을 입력하세요:', 'New Goal');
  if(!title) return;
  const id = (title.toLowerCase().replace(/\s+/g,'-') + '-' + Math.random().toString(36).slice(2,6)).slice(0,24);
  state.goals.push({ id, title, targetDate:'', timeline:[] });
  state.ui.activeGoalId = id;
  save(); render();
};

document.getElementById('btn-export').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `goalboard-${todayStr()}.json`;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
};

document.getElementById('file-import').onchange = async (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  try{
    const obj = JSON.parse(text);
    if(!obj.goals || !obj.ui) throw new Error('형식 불일치');
    state = obj; save(); render();
  }catch(err){ alert('가져오기 실패: ' + err.message); }
  e.target.value = '';
};

document.getElementById('btn-tts').onclick = ()=>{
  const goal = state.goals[activeGoalIndex()];
  const {current, next, issues} = deriveCurrentNextIssues(goal.timeline);
  const parts = [
    `오늘은 ${fmtKDate(new Date())}.`,
    `현재: ${current? current.title : '대기 중'}.`,
    issues[0] ? `이슈: ${issues[0].title}.` : '',
    next ? `다음: ${next.title} (${fmtKDate(next.date)}).` : ''
  ].filter(Boolean);
  speak(parts.join(' '));
};

document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft') setActiveByIndex(activeGoalIndex()-1);
  if(e.key==='ArrowRight') setActiveByIndex(activeGoalIndex()+1);
  if(e.key==='v' || e.key==='V') document.getElementById('btn-orient').click();
});

/* Touch swipe for goal switching */
let touchX=null, touchY=null, touchTime=0;
const area = document.querySelector('main');
area.addEventListener('touchstart', (e)=>{
  const t = e.changedTouches[0];
  touchX = t.clientX; touchY = t.clientY; touchTime = Date.now();
}, {passive:true});
area.addEventListener('touchend', (e)=>{
  const t = e.changedTouches[0];
  const dx = t.clientX - touchX; const dy = t.clientY - touchY;
  const dt = Date.now() - touchTime;
  if(dt<600 && Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy)){
    if(dx<0) setActiveByIndex(activeGoalIndex()+1);
    else setActiveByIndex(activeGoalIndex()-1);
  }
}, {passive:true});

/* TTS */
function speak(text){
  try{
    const synth = window.speechSynthesis;
    if(!synth) return alert('이 브라우저는 TTS를 지원하지 않습니다.');
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ko-KR';
    u.rate = 1.0; u.pitch = 1.0;
    synth.cancel(); synth.speak(u);
  }catch(err){ alert('TTS 오류: '+err.message); }
}

/* Boot */
render();
</script>
</body>
</html>