<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WEB Channel Rack + Piano Roll</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1623;
      --panel2:#111a2a;
      --text:#e8eef6;
      --muted:#9fb1c5;
      --line:rgba(255,255,255,.08);
      --accent:#B57CFF;

      --shadow:0 16px 40px rgba(0,0,0,.45);
      --radius:18px;

      --cell:26px;
      --gap:6px;

      --step:#1a2335;
      --step2:#26324a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
	  margin:0;
	  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial,sans-serif;
	  color:var(--text);
	  background:
		radial-gradient(900px 500px at 12% 10%, rgba(181,124,255,.18), transparent 55%),
		radial-gradient(800px 480px at 90% 20%, rgba(80,200,255,.10), transparent 55%),
		radial-gradient(900px 650px at 40% 120%, rgba(255,77,109,.10), transparent 60%),
		var(--bg);

	  /* í•µì‹¬: ê°€ìš´ë° ì •ë ¬ ì œê±° */
	  display:block;

	  /* ìŠ¤í¬ë¡¤ ì •ìƒí™” */
	  min-height:100vh;

	  /* ìƒë‹¨ ì—¬ë°±(ëª¨ë°”ì¼ ë…¸ì¹˜ê¹Œì§€ ëŒ€ì‘) */
	  padding: max(18px, env(safe-area-inset-top)) 18px 18px;
	}
    .app{
      width:min(1180px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 60%), var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
	  margin: 0 auto;
      overflow:hidden;
    }
    header{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:240px;
    }
    .dot{
      width:12px;height:12px;border-radius:4px;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(181,124,255,.18);
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:14px}
    .title span{display:block;font-size:12px;color:var(--muted)}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      max-width:760px;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition:.15s transform, .15s background;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.07)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(181,124,255,.14);
      border-color:rgba(181,124,255,.35);
    }
    .btn.danger{
      background:rgba(255,77,109,.12);
      border-color:rgba(255,77,109,.35);
    }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(0,0,0,.15);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .pill input[type="range"]{width:130px}
    .pill input[type="number"]{
      width:70px;
      background:transparent;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      outline:none;
    }
    .pill select{
      background:transparent;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:6px 8px;
      outline:none;
    }
    main{padding:14px 16px 16px}
    .rack{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:12px;
      align-items:start;
    }
    .left{
      background:rgba(0,0,0,.15);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      position:sticky;
      top:12px;
      max-height:72vh;
      overflow:auto;
    }
    .sectionTitle{
      font-size:12px;
      color:var(--muted);
      margin:4px 6px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .track{
      border:1px solid transparent;
      border-radius:14px;
      padding:10px;
      margin:8px 0;
      background:rgba(255,255,255,.02);
    }
    .track.active{
      border-color:rgba(181,124,255,.22);
      background:rgba(181,124,255,.08);
    }
    .tTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .tName{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
      flex:1;
    }
    .tName b{
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.12);
      color:var(--muted);
      flex:0 0 auto;
    }
    .tBtns{
      display:flex;
      gap:6px;
      flex:0 0 auto;
    }
    .mini{
      padding:6px 8px;
      border-radius:10px;
      font-size:11px;
    }
    .mini.on{
      border-color:rgba(34,255,85,.35);
      background:rgba(34,255,85,.10);
    }
    .mini.solo.on{
      border-color:rgba(255,200,80,.40);
      background:rgba(255,200,80,.10);
    }
    .tControls{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      margin-top:10px;
    }
    .row2{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .row2 label{
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .row2 input[type="range"]{width:160px}
    .row2 input[type="text"]{
      flex:1;
      min-width:140px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
    }
    .row2 input[type="file"]{max-width:100%}

    .right{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .panel{
      background:rgba(0,0,0,.15);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      overflow:auto;
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .panelHead .ttl{
      font-size:12px;
      color:var(--muted);
    }
    .pageNav{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pageBtn{
      padding:6px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
    }
    .pageBtn.active{
      background:rgba(181,124,255,.14);
      border-color:rgba(181,124,255,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(16, var(--cell));
      gap:var(--gap);
      align-items:center;
      justify-content:start;
      min-width:calc(16 * var(--cell) + 15 * var(--gap));
    }
    .rowlabel{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      margin-bottom:8px;
      font-size:12px;
      color:var(--muted);
    }
    .step{
      width:var(--cell);
      height:var(--cell);
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent), var(--step);
      cursor:pointer;
      position:relative;
      outline:none;
      transition:.08s transform, .08s filter;
    }
    .step:hover{filter:brightness(1.12)}
    .step:active{transform:translateY(1px)}
    .step.on{
      background:linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.02)), var(--step2);
      border-color:rgba(255,255,255,.20);
      box-shadow:0 0 0 2px rgba(34,255,85,.08) inset;
    }
    .step.on::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:6px;
      background:linear-gradient(180deg, rgba(34,255,85,.95), rgba(34,255,85,.35));
      opacity:.92;
    }
    .step.playhead{
      box-shadow:0 0 0 2px rgba(255,255,255,.20) inset, 0 0 0 1px rgba(255,255,255,.10);
      outline:2px solid rgba(255,255,255,.10);
    }

    /* piano roll */
    .pianoWrap{overflow:auto}
    .piano{
      display:grid;
      grid-template-columns: 90px repeat(16, var(--cell));
      gap:var(--gap);
      align-items:center;
      justify-content:start;
      min-width:calc(90px + 16 * var(--cell) + 15 * var(--gap));
    }
    .key{
      height:22px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
    }
    .pstep{
      width:var(--cell);
      height:22px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      cursor:pointer;
      position:relative;
    }
    .pstep.on{
      background:rgba(181,124,255,.18);
      border-color:rgba(181,124,255,.35);
    }
    .pstep.playhead{
      outline:2px solid rgba(255,255,255,.10);
      box-shadow:0 0 0 2px rgba(255,255,255,.15) inset;
    }

    footer{
      padding:10px 16px 14px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(0deg, rgba(255,255,255,.02), transparent);
    }
    .hint code{
      padding:2px 6px;border:1px solid var(--line);border-radius:8px;
      background:rgba(0,0,0,.2); color:var(--text);
    }

    /* modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(920px, 100%);
      background:var(--panel2);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead b{font-size:13px}
    .modalBody{padding:12px 14px; display:grid; gap:10px}
    textarea{
      width:100%;
      min-height:260px;
      resize:vertical;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      color:var(--text);
      padding:12px;
      outline:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      line-height:1.35;
    }

    @media (max-width: 980px){
      .rack{grid-template-columns:1fr}
      .left{position:relative; max-height:none}
      :root{--cell:24px}
      .piano{grid-template-columns: 86px repeat(16, var(--cell))}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div class="title">
          <b>WEB Channel Rack + Piano Roll</b>
          <span>16/32/64 steps Â· page view Â· mute/solo Â· sample load Â· JSON save/load</span>
        </div>
      </div>

      <div class="controls">
        <button class="btn primary" id="btnPlay">â–¶ Play</button>
        <button class="btn" id="btnStop">â–  Stop</button>

        <div class="pill">
          <span>BPM</span>
          <input id="bpm" type="range" min="60" max="200" value="120" />
          <input id="bpmNum" type="number" min="40" max="240" value="120" />
        </div>

        <div class="pill">
          <span>Swing</span>
          <input id="swing" type="range" min="0" max="60" value="0" />
          <span id="swingVal">0%</span>
        </div>

        <div class="pill">
          <span>Steps</span>
          <select id="stepsSel">
            <option value="16">16</option>
            <option value="32">32</option>
            <option value="64">64</option>
          </select>
        </div>

        <button class="btn" id="btnRandom">ğŸ² Random</button>
        <button class="btn danger" id="btnClear">ğŸ§¹ Clear</button>

        <button class="btn" id="btnIO">ğŸ’¾ Save/Load</button>
      </div>
    </header>

    <main>
      <div class="rack">
        <div class="left">
          <div class="sectionTitle">
            <span>Channels</span>
            <span style="opacity:.8">Mute/Solo/Name/Sample</span>
          </div>
          <div id="trackList"></div>
        </div>

        <div class="right">
          <div class="panel">
            <div class="panelHead">
              <div class="ttl" id="stepperTitle">Drum Rack (Page 1/1)</div>
              <div class="pageNav" id="pageNav"></div>
            </div>

            <div class="rowlabel">
              <span>ë“œëŸ¼ ìŠ¤í…(í´ë¦­ on/off) Â· í˜„ì¬ í˜ì´ì§€ëŠ” 16ìŠ¤í…ë§Œ í‘œì‹œ</span>
              <span id="status">Step: 1 / 16</span>
            </div>

            <div id="drumRows"></div>
          </div>

          <div class="panel">
            <div class="panelHead">
              <div class="ttl">Piano Roll (Melody)</div>
              <div class="pill">
                <span>Oct</span>
                <select id="octSel">
                  <option value="3">3</option>
                  <option value="4" selected>4</option>
                  <option value="5">5</option>
                </select>
                <span style="opacity:.75">2ì˜¥íƒ€ë¸Œ</span>
              </div>
            </div>

            <div class="rowlabel">
              <span>í”¼ì•„ë…¸ë¡¤: í•œ ìŠ¤í…ë‹¹ 1ë…¸íŠ¸(ë®ì–´ì“°ê¸°). ì…€ í´ë¦­í•˜ë©´ í† ê¸€ + ì¦‰ì‹œ í”„ë¦¬ë·°</span>
              <span style="opacity:.85">í‚¤ë³´ë“œ: <b style="color:var(--text)">Space</b> ì¬ìƒ Â· <b style="color:var(--text)">R</b> ëœë¤ Â· <b style="color:var(--text)">C</b> í´ë¦¬ì–´</span>
            </div>

            <div class="pianoWrap">
              <div id="pianoGrid"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="hint">íŒ: <code>Save/Load</code>ì—ì„œ JSON ë³µì‚¬/ë¶™ì—¬ë„£ê¸° or íŒŒì¼ë¡œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê°€ëŠ¥</div>
      <div style="opacity:.85">ìƒ˜í”Œ ì—…ë¡œë“œ: Kick/Snare/Hat/Clap ê°ê° WAV/MP3 ê°€ëŠ¥ (ì—†ìœ¼ë©´ ë‚´ì¥ í•©ì„±ë“œëŸ¼)</div>
    </footer>
  </div>

  <!-- IO MODAL -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <b>Pattern Save / Load (JSON)</b>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn mini" id="btnCopy">ğŸ“‹ Copy</button>
          <button class="btn mini" id="btnDownload">â¬‡ Download .json</button>
          <label class="btn mini" style="cursor:pointer">
            â¬† Load .json <input type="file" id="fileLoadJson" accept="application/json" style="display:none">
          </label>
          <button class="btn mini danger" id="btnCloseModal">ë‹«ê¸°</button>
        </div>
      </div>
      <div class="modalBody">
        <textarea id="ioText" spellcheck="false"></textarea>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;align-items:center">
          <div style="color:var(--muted);font-size:12px">
            ë¶™ì—¬ë„£ê³  <b style="color:var(--text)">Apply</b> ëˆ„ë¥´ë©´ ì¦‰ì‹œ ë°˜ì˜ë¨ (ìƒ˜í”Œ ì˜¤ë””ì˜¤ëŠ” JSONì— í¬í•¨ ì•ˆ í•¨)
          </div>
          <button class="btn primary" id="btnApply">âœ… Apply</button>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // Audio
  // =========================
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const ctx = new AudioCtx();

  const master = ctx.createGain();
  master.gain.value = 0.9;
  master.connect(ctx.destination);

  async function safeResumeAudio(){
    if (ctx.state !== "running") {
      try{ await ctx.resume(); }catch(e){}
    }
  }
  window.addEventListener("pointerdown", () => { safeResumeAudio(); }, { passive:true });

  const makeNoiseBuffer = (seconds=0.2) => {
    const sr = ctx.sampleRate;
    const buffer = ctx.createBuffer(1, Math.floor(sr * seconds), sr);
    const data = buffer.getChannelData(0);
    for (let i=0;i<data.length;i++) data[i] = (Math.random()*2-1);
    return buffer;
  };
  const noiseBufShort = makeNoiseBuffer(0.08);
  const noiseBufMed   = makeNoiseBuffer(0.22);

  // fallback synth drums
  function kickSynth(t, vol=1){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(140, t);
    o.frequency.exponentialRampToValueAtTime(50, t + 0.06);
    o.frequency.exponentialRampToValueAtTime(35, t + 0.12);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.9 * vol, t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.16);
    o.connect(g); g.connect(master);
    o.start(t);
    o.stop(t + 0.18);

    const ns = ctx.createBufferSource();
    const ng = ctx.createGain();
    ns.buffer = noiseBufShort;
    ng.gain.setValueAtTime(0.25 * vol, t);
    ng.gain.exponentialRampToValueAtTime(0.0001, t + 0.03);
    ns.connect(ng); ng.connect(master);
    ns.start(t);
    ns.stop(t + 0.05);
  }

  function snareSynth(t, vol=1){
    const ns = ctx.createBufferSource();
    const nf = ctx.createBiquadFilter();
    const ng = ctx.createGain();
    ns.buffer = noiseBufMed;
    nf.type = "highpass";
    nf.frequency.setValueAtTime(800, t);
    ng.gain.setValueAtTime(0.0001, t);
    ng.gain.exponentialRampToValueAtTime(0.7 * vol, t + 0.003);
    ng.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
    ns.connect(nf); nf.connect(ng); ng.connect(master);
    ns.start(t);
    ns.stop(t + 0.22);

    const o = ctx.createOscillator();
    const og = ctx.createGain();
    o.type = "triangle";
    o.frequency.setValueAtTime(200, t);
    og.gain.setValueAtTime(0.0001, t);
    og.gain.exponentialRampToValueAtTime(0.25 * vol, t + 0.003);
    og.gain.exponentialRampToValueAtTime(0.0001, t + 0.12);
    o.connect(og); og.connect(master);
    o.start(t); o.stop(t + 0.14);
  }

  function hatSynth(t, vol=1){
    const ns = ctx.createBufferSource();
    const hp = ctx.createBiquadFilter();
    const g = ctx.createGain();
    ns.buffer = noiseBufShort;
    hp.type = "highpass";
    hp.frequency.setValueAtTime(5000, t);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(0.35 * vol, t + 0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.05);
    ns.connect(hp); hp.connect(g); g.connect(master);
    ns.start(t); ns.stop(t + 0.08);
  }

  function clapSynth(t, vol=1){
    const bursts = [0, 0.012, 0.024];
    bursts.forEach((dt, i) => {
      const ns = ctx.createBufferSource();
      const bp = ctx.createBiquadFilter();
      const g = ctx.createGain();
      ns.buffer = noiseBufShort;
      bp.type = "bandpass";
      bp.frequency.setValueAtTime(1800, t + dt);
      bp.Q.setValueAtTime(0.8, t + dt);
      const peak = (0.35 - i*0.07) * vol;
      g.gain.setValueAtTime(0.0001, t + dt);
      g.gain.exponentialRampToValueAtTime(Math.max(0.0001, peak), t + dt + 0.002);
      g.gain.exponentialRampToValueAtTime(0.0001, t + dt + 0.05);
      ns.connect(bp); bp.connect(g); g.connect(master);
      ns.start(t + dt); ns.stop(t + dt + 0.07);
    });
  }

  function playSample(buffer, t, vol=1){
    if (!buffer) return false;
    const src = ctx.createBufferSource();
    const g = ctx.createGain();
    src.buffer = buffer;
    g.gain.setValueAtTime(Math.max(0, vol), t);
    src.connect(g); g.connect(master);
    src.start(t);
    return true;
  }

  // Melody synth (simple mono per step)
  function midiToHz(m){
    return 440 * Math.pow(2, (m - 69) / 12);
  }
  function melodySynth(t, midi, vol=0.7, len=0.12){
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    const f = midiToHz(midi);

    o.type = "sawtooth";
    o.frequency.setValueAtTime(f, t);

    // ADSR-ish
    const a = 0.008, d = 0.06, s = 0.35, r = 0.06;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(vol, t + a);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001, vol * s), t + a + d);
    g.gain.setValueAtTime(Math.max(0.0001, vol * s), t + len);
    g.gain.exponentialRampToValueAtTime(0.0001, t + len + r);

    // gentle filter
    const lp = ctx.createBiquadFilter();
    lp.type = "lowpass";
    lp.frequency.setValueAtTime(Math.min(12000, f * 6), t);
    lp.Q.setValueAtTime(0.7, t);

    o.connect(lp); lp.connect(g); g.connect(master);
    o.start(t);
    o.stop(t + len + r + 0.02);
  }

  // =========================
  // Data Model
  // =========================
  const TRACKS = [
    { id:"kick",  type:"drum", name:"Kick",  vol:0.95, muted:false, solo:false, sampleBuffer:null, synth: kickSynth },
    { id:"snare", type:"drum", name:"Snare", vol:0.85, muted:false, solo:false, sampleBuffer:null, synth: snareSynth },
    { id:"hat",   type:"drum", name:"HiHat", vol:0.70, muted:false, solo:false, sampleBuffer:null, synth: hatSynth },
    { id:"clap",  type:"drum", name:"Clap",  vol:0.80, muted:false, solo:false, sampleBuffer:null, synth: clapSynth },
    { id:"melody",type:"midi", name:"Melody",vol:0.70, muted:false, solo:false }
  ];

  let stepsLen = 16;         // 16/32/64
  let page = 0;              // page index (0..pages-1), each page shows 16 steps
  const PAGE_SIZE = 16;

  // drum patterns: boolean arrays
  // melody: int|null per step (midi)
  const pattern = {
    kick:   [],
    snare:  [],
    hat:    [],
    clap:   [],
    melody: []
  };

  function ensurePatternLength(newLen){
    for (const tr of TRACKS){
      const id = tr.id;
      const arr = pattern[id];
      const isMidi = tr.type === "midi";
      if (arr.length < newLen){
        const add = newLen - arr.length;
        for (let i=0;i<add;i++) arr.push(isMidi ? null : false);
      } else if (arr.length > newLen){
        arr.length = newLen;
      }
    }
  }

  // default init
  stepsLen = 16;
  ensurePatternLength(stepsLen);
  // basic groove
  pattern.kick[0]=true; pattern.kick[8]=true;
  pattern.snare[4]=true; pattern.snare[12]=true;
  for(let i=0;i<stepsLen;i+=2) pattern.hat[i]=true;
  pattern.clap[12]=true;
  // melody example
  pattern.melody[0]=60; pattern.melody[4]=62; pattern.melody[8]=67; pattern.melody[12]=65;

  // =========================
  // UI Refs
  // =========================
  const trackListEl = document.getElementById("trackList");
  const drumRowsEl  = document.getElementById("drumRows");
  const pageNavEl   = document.getElementById("pageNav");
  const stepperTitle= document.getElementById("stepperTitle");
  const statusEl    = document.getElementById("status");

  const btnPlay = document.getElementById("btnPlay");
  const btnStop = document.getElementById("btnStop");

  const bpm = document.getElementById("bpm");
  const bpmNum = document.getElementById("bpmNum");

  const swing = document.getElementById("swing");
  const swingVal = document.getElementById("swingVal");

  const stepsSel = document.getElementById("stepsSel");
  const btnRandom = document.getElementById("btnRandom");
  const btnClear = document.getElementById("btnClear");

  const btnIO = document.getElementById("btnIO");
  const modalBack = document.getElementById("modalBack");
  const ioText = document.getElementById("ioText");
  const btnCloseModal = document.getElementById("btnCloseModal");
  const btnApply = document.getElementById("btnApply");
  const btnCopy = document.getElementById("btnCopy");
  const btnDownload = document.getElementById("btnDownload");
  const fileLoadJson = document.getElementById("fileLoadJson");

  const pianoGridEl = document.getElementById("pianoGrid");
  const octSel = document.getElementById("octSel");

  // =========================
  // Helpers
  // =========================
  function pagesCount(){ return Math.max(1, Math.ceil(stepsLen / PAGE_SIZE)); }
  function pageStart(){ return page * PAGE_SIZE; }
  function pageEnd(){ return Math.min(stepsLen, pageStart() + PAGE_SIZE); }

  function hasAnySolo(){
    return TRACKS.some(t => t.solo);
  }
  function isTrackAudible(tr){
    if (tr.muted) return false;
    const soloing = hasAnySolo();
    if (!soloing) return true;
    return tr.solo;
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function updateBpmUI(val){
    bpm.value = String(val);
    bpmNum.value = String(val);
  }

  // =========================
  // Render: Track List (Mute/Solo/Name/Vol/Sample)
  // =========================
  function renderTrackList(){
    trackListEl.innerHTML = "";

    TRACKS.forEach(tr => {
      const wrap = document.createElement("div");
      wrap.className = "track";

      const top = document.createElement("div");
      top.className = "tTop";

      const left = document.createElement("div");
      left.className = "tName";
      left.innerHTML = `
        <span class="chip">${tr.type.toUpperCase()}</span>
        <b title="${tr.name}">${tr.name}</b>
      `;

      const btns = document.createElement("div");
      btns.className = "tBtns";

      const muteBtn = document.createElement("button");
      muteBtn.className = "btn mini" + (tr.muted ? " on" : "");
      muteBtn.textContent = tr.muted ? "Muted" : "Mute";
      muteBtn.addEventListener("click", () => {
        tr.muted = !tr.muted;
        renderTrackList();
      });

      const soloBtn = document.createElement("button");
      soloBtn.className = "btn mini solo" + (tr.solo ? " on" : "");
      soloBtn.textContent = tr.solo ? "Soloed" : "Solo";
      soloBtn.addEventListener("click", () => {
        tr.solo = !tr.solo;
        renderTrackList();
      });

      btns.appendChild(muteBtn);
      btns.appendChild(soloBtn);

      top.appendChild(left);
      top.appendChild(btns);

      const controls = document.createElement("div");
      controls.className = "tControls";

      // rename + volume
      const rowA = document.createElement("div");
      rowA.className = "row2";
      rowA.innerHTML = `
        <label>NAME</label>
        <input type="text" value="${tr.name}" data-name="${tr.id}">
        <label>VOL</label>
        <input type="range" min="0" max="120" value="${Math.round(tr.vol*100)}" data-vol="${tr.id}">
      `;

      // sample loader for drums
      const rowB = document.createElement("div");
      rowB.className = "row2";
      if (tr.type === "drum") {
        rowB.innerHTML = `
          <label>Sample</label>
          <input type="file" accept="audio/*" data-sample="${tr.id}">
          <span style="color:var(--muted);font-size:11px">
            ${tr.sampleBuffer ? "Loaded âœ…" : "None (Synth fallback)"}
          </span>
        `;
      } else {
        rowB.innerHTML = `
          <span style="color:var(--muted);font-size:11px">
            MelodyëŠ” ë‚´ì¥ ì‹ ìŠ¤ë¡œ ì¬ìƒë©ë‹ˆë‹¤.
          </span>
        `;
      }

      controls.appendChild(rowA);
      controls.appendChild(rowB);

      wrap.appendChild(top);
      wrap.appendChild(controls);

      trackListEl.appendChild(wrap);
    });

    // bind rename
    trackListEl.querySelectorAll('input[type="text"][data-name]').forEach(inp => {
      inp.addEventListener("input", (e) => {
        const id = e.target.dataset.name;
        const tr = TRACKS.find(t => t.id === id);
        tr.name = e.target.value || id;
        // top label ì¦‰ì‹œ ê°±ì‹ 
        renderAllPanels(false);
      });
    });

    // bind vol
    trackListEl.querySelectorAll('input[type="range"][data-vol]').forEach(inp => {
      inp.addEventListener("input", (e) => {
        const id = e.target.dataset.vol;
        const tr = TRACKS.find(t => t.id === id);
        tr.vol = clamp(Number(e.target.value)/100, 0, 1.2);
      });
    });

    // bind sample load
    trackListEl.querySelectorAll('input[type="file"][data-sample]').forEach(inp => {
      inp.addEventListener("change", async (e) => {
        const id = e.target.dataset.sample;
        const tr = TRACKS.find(t => t.id === id);
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        await safeResumeAudio();
        try{
          const arrBuf = await file.arrayBuffer();
          const audioBuf = await ctx.decodeAudioData(arrBuf.slice(0));
          tr.sampleBuffer = audioBuf;
          renderTrackList();
        }catch(err){
          console.error(err);
          alert("ì˜¤ë””ì˜¤ ë””ì½”ë”© ì‹¤íŒ¨! ë‹¤ë¥¸ íŒŒì¼(WAV/MP3)ì„ ì‹œë„í•´ë´ìš”.");
        }
      });
    });
  }

  // =========================
  // Render: Page Nav
  // =========================
  function renderPageNav(){
    const pcount = pagesCount();
    page = clamp(page, 0, pcount - 1);

    pageNavEl.innerHTML = "";
    for(let i=0;i<pcount;i++){
      const b = document.createElement("button");
      b.className = "pageBtn" + (i===page ? " active":"");
      b.textContent = `Page ${i+1}`;
      b.addEventListener("click", () => {
        page = i;
        renderAllPanels(false);
      });
      pageNavEl.appendChild(b);
    }
    stepperTitle.textContent = `Drum Rack (Page ${page+1}/${pcount})`;
  }

  // =========================
  // Render: Drum Grid (current page only)
  // =========================
  function renderDrumGrid(){
    drumRowsEl.innerHTML = "";
    const start = pageStart();
    const end = pageEnd();

    const drumTracks = TRACKS.filter(t => t.type==="drum");

    drumTracks.forEach(tr => {
      const rowLabel = document.createElement("div");
      rowLabel.className = "rowlabel";
      rowLabel.innerHTML = `
        <span><b style="color:var(--text)">${tr.name}</b> <span style="opacity:.75">(${tr.id})</span></span>
        <span style="opacity:.85">${isTrackAudible(tr) ? "ğŸ”Š audible" : "ğŸ”‡ muted/unsoloed"}</span>
      `;

      const grid = document.createElement("div");
      grid.className = "grid";

      for(let s=start; s<end; s++){
        const cell = document.createElement("button");
        cell.className = "step" + (pattern[tr.id][s] ? " on":"");
        cell.type="button";
        cell.dataset.track = tr.id;
        cell.dataset.step = String(s);

        cell.addEventListener("click", async () => {
          pattern[tr.id][s] = !pattern[tr.id][s];
          cell.classList.toggle("on", pattern[tr.id][s]);

          // click preview
          await safeResumeAudio();
          const now = ctx.currentTime + 0.01;
          if (!isTrackAudible(tr)) return;
          if (tr.sampleBuffer) playSample(tr.sampleBuffer, now, tr.vol);
          else tr.synth(now, tr.vol);
        });

        grid.appendChild(cell);
      }

      drumRowsEl.appendChild(rowLabel);
      drumRowsEl.appendChild(grid);
    });
  }

  // =========================
  // Render: Piano Roll (current page only)
  // 2 octaves, 12 semitones each = 24 rows
  // Each step holds at most one midi note. Clicking sets that step's note to clicked pitch.
  // Clicking an already-selected pitch on that step clears it.
  // =========================
  function noteName(midi){
    const names = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
    const n = names[midi % 12];
    const o = Math.floor(midi/12) - 1;
    return `${n}${o}`;
  }

  function buildPitches(){
    const baseOct = Number(octSel.value); // e.g. 4
    const baseMidi = (baseOct + 1) * 12;  // C of that octave
    // 2 octaves: from C(baseOct) to B(baseOct+1)
    const pitches = [];
    for(let i=0;i<24;i++){
      pitches.push(baseMidi + (23 - i)); // top is higher pitch
    }
    return pitches;
  }

  function renderPianoRoll(){
    const start = pageStart();
    const end = pageEnd();

    const pitches = buildPitches();

    const piano = document.createElement("div");
    piano.className = "piano";

    // build rows
    pitches.forEach((midi) => {
      const key = document.createElement("div");
      key.className = "key";
      key.innerHTML = `<span>${noteName(midi)}</span><span style="opacity:.7">${midi}</span>`;
      piano.appendChild(key);

      for(let s=start; s<end; s++){
        const ps = document.createElement("div");
        ps.className = "pstep";
        ps.dataset.step = String(s);
        ps.dataset.midi = String(midi);

        const cur = pattern.melody[s];
        if (cur === midi) ps.classList.add("on");

        ps.addEventListener("click", async () => {
          await safeResumeAudio();
          const tr = TRACKS.find(t => t.id==="melody");
          if (!isTrackAudible(tr)) return;

          const curNote = pattern.melody[s];
          if (curNote === midi){
            pattern.melody[s] = null;
            ps.classList.remove("on");
          } else {
            // clear other pitch cells in this step (within visible grid only)
            pattern.melody[s] = midi;
            // update UI for this step: remove any existing .on in this column (page visible)
            piano.querySelectorAll(`.pstep[data-step="${s}"]`).forEach(el => el.classList.remove("on"));
            ps.classList.add("on");

            // preview
            melodySynth(ctx.currentTime + 0.01, midi, tr.vol, 0.16);
          }
        });

        piano.appendChild(ps);
      }
    });

    pianoGridEl.innerHTML = "";
    pianoGridEl.appendChild(piano);
  }

  // =========================
  // Playhead highlight
  // =========================
  function clearPlayhead(){
    document.querySelectorAll(".step.playhead, .pstep.playhead").forEach(el => el.classList.remove("playhead"));
  }
  function setPlayhead(globalStep){
    // only highlight if within current page
    clearPlayhead();
    statusEl.textContent = `Step: ${globalStep+1} / ${stepsLen}`;

    const start = pageStart();
    const end = pageEnd();
    if (globalStep < start || globalStep >= end) return;

    document.querySelectorAll(`.step[data-step="${globalStep}"]`).forEach(el => el.classList.add("playhead"));
    document.querySelectorAll(`.pstep[data-step="${globalStep}"]`).forEach(el => el.classList.add("playhead"));
  }

  // =========================
  // Transport Scheduler (stable)
  // =========================
  let isPlaying = false;

  let currentStep = 0;      // 0..stepsLen-1
  let nextNoteTime = 0;     // AudioContext time
  let timerID = null;

  const lookahead = 25;     // ms
  const scheduleAheadTime = 0.12; // sec

  function secondsPer16th(){
    return (60 / Number(bpm.value)) / 4;
  }

  function stepTimeOffset(stepIdx){
    // swing: delay odd 16ths
    const swingAmt = Number(swing.value) / 100; // 0..0.6
    const sp16 = secondsPer16th();
    const isOdd = (stepIdx % 2) === 1;
    return isOdd ? sp16 * swingAmt * 0.60 : 0;
  }

  function scheduleStep(stepIdx, t){
    // drums
    for (const tr of TRACKS){
      if (!isTrackAudible(tr)) continue;

      if (tr.type === "drum"){
        if (pattern[tr.id][stepIdx]){
          // sample first, fallback synth
          if (tr.sampleBuffer) playSample(tr.sampleBuffer, t, tr.vol);
          else tr.synth(t, tr.vol);
        }
      } else if (tr.id === "melody"){
        const midi = pattern.melody[stepIdx];
        if (typeof midi === "number"){
          melodySynth(t, midi, tr.vol, Math.min(0.22, secondsPer16th()*0.95));
        }
      }
    }
  }

  function nextStep(){
    const sp16 = secondsPer16th();
    currentStep = (currentStep + 1) % stepsLen;
    nextNoteTime += sp16 + stepTimeOffset(currentStep);
  }

  function scheduler(){
    while (nextNoteTime < ctx.currentTime + scheduleAheadTime){
      scheduleStep(currentStep, nextNoteTime);
      // UI playhead: do it close to schedule time
      const stepToShow = currentStep;
      const delayMs = Math.max(0, (nextNoteTime - ctx.currentTime) * 1000);
      setTimeout(() => setPlayhead(stepToShow), delayMs);

      nextStep();
    }
  }

  async function play(){
    if (isPlaying) return;
    await safeResumeAudio();
    isPlaying = true;
    btnPlay.textContent = "â¸ Pause";

    currentStep = currentStep % stepsLen;
    nextNoteTime = ctx.currentTime + 0.06;

    timerID = setInterval(scheduler, lookahead);
  }

  function pause(){
    isPlaying = false;
    btnPlay.textContent = "â–¶ Play";
    if (timerID){ clearInterval(timerID); timerID = null; }
    clearPlayhead();
    statusEl.textContent = `Paused (next: ${currentStep+1}/${stepsLen})`;
  }

  function stop(){
    isPlaying = false;
    btnPlay.textContent = "â–¶ Play";
    if (timerID){ clearInterval(timerID); timerID = null; }
    currentStep = 0;
    clearPlayhead();
    setPlayhead(0);
  }

  // =========================
  // Random / Clear
  // =========================
  function randomize(){
    for (const tr of TRACKS){
      if (tr.type === "drum"){
        for(let i=0;i<stepsLen;i++){
          const p =
            tr.id==="hat"   ? 0.55 :
            tr.id==="kick"  ? 0.22 :
            tr.id==="snare" ? 0.16 :
            0.10;
          pattern[tr.id][i] = Math.random() < p;
        }
      } else if (tr.id === "melody"){
        for(let i=0;i<stepsLen;i++){
          pattern.melody[i] = null;
        }
        // ê°„ë‹¨í•œ ìŒê³„ ê¸°ë°˜ ëœë¤ (C major-ish)
        const scale = [0,2,4,5,7,9,11];
        const base = ((Number(octSel.value)+1) * 12); // C
        for(let i=0;i<stepsLen;i++){
          if (Math.random() < 0.18){
            const deg = scale[Math.floor(Math.random()*scale.length)];
            const oct = Math.random() < 0.5 ? 0 : 12;
            pattern.melody[i] = base + deg + oct;
          }
        }
      }
    }
    // ë³´ì •
    pattern.kick[0]=true;
    pattern.snare[4]=true; if (stepsLen>12) pattern.snare[12]=true;
    renderAllPanels(false);
  }

  function clearAll(){
    for (const tr of TRACKS){
      if (tr.type === "drum"){
        pattern[tr.id].fill(false);
      } else if (tr.id==="melody"){
        pattern.melody.fill(null);
      }
    }
    renderAllPanels(false);
  }

  // =========================
  // Save / Load JSON
  // =========================
  function exportState(){
    // note: sampleBufferëŠ” íŒŒì¼ ë°”ì´ë„ˆë¦¬ë¼ JSONì— ë„£ì§€ ì•ŠìŒ
    return {
      version: 1,
      stepsLen,
      bpm: Number(bpm.value),
      swing: Number(swing.value),
      pageSize: PAGE_SIZE,
      tracks: TRACKS.map(t => ({
        id: t.id,
        type: t.type,
        name: t.name,
        vol: t.vol,
        muted: t.muted,
        solo: t.solo,
        hasSample: !!t.sampleBuffer
      })),
      pattern: {
        kick:  pattern.kick.slice(0),
        snare: pattern.snare.slice(0),
        hat:   pattern.hat.slice(0),
        clap:  pattern.clap.slice(0),
        melody: pattern.melody.slice(0)
      }
    };
  }

  function applyState(obj){
    if (!obj || typeof obj !== "object") throw new Error("invalid json");
    const newLen = Number(obj.stepsLen || 16);
    stepsLen = [16,32,64].includes(newLen) ? newLen : 16;
    stepsSel.value = String(stepsLen);
    ensurePatternLength(stepsLen);

    const nbpm = clamp(Number(obj.bpm || 120), 40, 240);
    updateBpmUI(nbpm);

    const sw = clamp(Number(obj.swing || 0), 0, 60);
    swing.value = String(sw);
    swingVal.textContent = sw + "%";

    // tracks settings
    if (Array.isArray(obj.tracks)){
      obj.tracks.forEach(ts => {
        const tr = TRACKS.find(t => t.id === ts.id);
        if (!tr) return;
        if (typeof ts.name === "string") tr.name = ts.name;
        if (typeof ts.vol === "number") tr.vol = clamp(ts.vol, 0, 1.2);
        if (typeof ts.muted === "boolean") tr.muted = ts.muted;
        if (typeof ts.solo === "boolean") tr.solo = ts.solo;
      });
    }

    // pattern
    const p = obj.pattern || {};
    for (const tr of TRACKS){
      const id = tr.id;
      if (id === "melody"){
        const arr = Array.isArray(p.melody) ? p.melody : null;
        if (arr){
          pattern.melody = arr.map(v => (typeof v === "number" ? v : null)).slice(0, stepsLen);
          ensurePatternLength(stepsLen);
        }
      } else {
        const arr = Array.isArray(p[id]) ? p[id] : null;
        if (arr){
          pattern[id] = arr.map(v => !!v).slice(0, stepsLen);
          ensurePatternLength(stepsLen);
        }
      }
    }

    // page adjust
    page = clamp(page, 0, pagesCount()-1);
    currentStep = currentStep % stepsLen;

    renderAllPanels(false);
  }

  function openIOModal(){
    ioText.value = JSON.stringify(exportState(), null, 2);
    modalBack.style.display = "flex";
  }
  function closeIOModal(){
    modalBack.style.display = "none";
  }

  btnIO.addEventListener("click", openIOModal);
  btnCloseModal.addEventListener("click", closeIOModal);
  modalBack.addEventListener("click", (e) => {
    if (e.target === modalBack) closeIOModal();
  });

  btnApply.addEventListener("click", () => {
    try{
      const obj = JSON.parse(ioText.value);
      applyState(obj);
      alert("ì ìš© ì™„ë£Œ!");
    }catch(e){
      alert("JSON íŒŒì‹±/ì ìš© ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ë´ìš”.");
      console.error(e);
    }
  });

  btnCopy.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(ioText.value);
      alert("ë³µì‚¬ ì™„ë£Œ!");
    }catch(e){
      alert("ë³µì‚¬ ì‹¤íŒ¨(ë¸Œë¼ìš°ì € ê¶Œí•œ) â€” í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ì¤˜!");
    }
  });

  btnDownload.addEventListener("click", () => {
    const blob = new Blob([ioText.value], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "pattern.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  fileLoadJson.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try{
      const text = await file.text();
      ioText.value = text;
      const obj = JSON.parse(text);
      applyState(obj);
      alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
    }catch(err){
      console.error(err);
      alert("JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!");
    }finally{
      fileLoadJson.value = "";
    }
  });

  // =========================
  // Controls bindings
  // =========================
  btnPlay.addEventListener("click", () => {
    if (!isPlaying) play();
    else pause();
  });
  btnStop.addEventListener("click", stop);

  bpm.addEventListener("input", () => updateBpmUI(bpm.value));
  bpmNum.addEventListener("input", () => {
    let v = Number(bpmNum.value || 120);
    v = clamp(v, 40, 240);
    updateBpmUI(v);
  });

  swing.addEventListener("input", () => {
    swingVal.textContent = swing.value + "%";
  });

  stepsSel.addEventListener("change", () => {
    const v = Number(stepsSel.value);
    const old = stepsLen;
    stepsLen = [16,32,64].includes(v) ? v : 16;
    ensurePatternLength(stepsLen);

    // hat: if expanding, keep simple even hats
    if (stepsLen > old && pattern.hat.every(x=>x===false)){
      for (let i=0;i<stepsLen;i+=2) pattern.hat[i]=true;
    }
    page = clamp(page, 0, pagesCount()-1);
    currentStep = currentStep % stepsLen;

    renderAllPanels(false);
  });

  btnRandom.addEventListener("click", randomize);
  btnClear.addEventListener("click", clearAll);

  octSel.addEventListener("change", () => renderPianoRoll());

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") { e.preventDefault(); btnPlay.click(); }
    if (e.key.toLowerCase() === "r") randomize();
    if (e.key.toLowerCase() === "c") clearAll();
    if (e.key.toLowerCase() === "s" && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      openIOModal();
    }
  });

  // =========================
  // Render all
  // =========================
  function renderAllPanels(resetPageNav=true){
    if (resetPageNav) page = clamp(page, 0, pagesCount()-1);
    renderTrackList();
    renderPageNav();
    renderDrumGrid();
    renderPianoRoll();
    setPlayhead(currentStep);
  }

  renderAllPanels(true);
  setPlayhead(0);

})();
</script>
</body>
</html>
