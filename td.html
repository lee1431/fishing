<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vanilla To-Do Advisor</title>
  <style>
    :root { --gap:12px; --bg:#0e0f13; --card:#151821; --ink:#e8ecf1; --muted:#9aa3ad; --accent:#7cc1ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--ink); }
    header { padding:20px; border-bottom:1px solid #222833; display:flex; gap:var(--gap); align-items:center; justify-content:space-between; }
    h1 { margin:0; font-size:18px; letter-spacing:.4px; }
    main { max-width:880px; margin:0 auto; padding:20px; display:grid; gap:var(--gap); }
    .row { display:flex; gap:var(--gap); flex-wrap:wrap; }
    .card { background:var(--card); border:1px solid #1d2230; border-radius:12px; padding:16px; }
    .grow { flex:1 1 360px; }
    label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, button, textarea { width:100%; background:#0f121b; color:var(--ink); border:1px solid #23293a; border-radius:10px; padding:12px; }
    button { cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:var(--gap); }
    .tasks { display:grid; gap:10px; }
    .task { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; border:1px dashed #2a3144; padding:12px; border-radius:10px; }
    .task h4 { margin:0 0 6px 0; font-size:14px; }
    .meta { font-size:12px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .chips { display:flex; gap:6px; flex-wrap:wrap; }
    .chip { font-size:11px; padding:4px 8px; border-radius:999px; background:#1b2232; border:1px solid #2a3144; }
    .actions { display:flex; gap:8px; }
    .pill { padding:8px 12px; border-radius:999px; border:1px solid #2a3144; background:#121625; }
    .accent { border-color:#2b82ff; }
    .muted { color:var(--muted); }
    .hint { font-size:12px; color:var(--muted); }
    .title-input { font-weight:600; }
    .today-list .task { border-style:solid; }
    .empty { color:var(--muted); text-align:center; padding:12px; }
  </style>
</head>
<body>
  <header>
    <h1>Vanilla To-Do Advisor 🍦</h1>
    <div class="hint">자동 추천 · 유동 재배치 · 오프라인 저장</div>
  </header>

  <main>
    <!-- 상태/기분 -->
    <section class="card grow">
      <h3 style="margin:0 0 10px">오늘 컨디션</h3>
      <div class="grid">
        <div>
          <label>기분(Mood)</label>
          <select id="mood">
            <option value="low">낮음</option>
            <option value="mid" selected>보통</option>
            <option value="high">좋음</option>
          </select>
        </div>
        <div>
          <label>에너지(Energy)</label>
          <select id="energy">
            <option value="low">낮음</option>
            <option value="mid" selected>보통</option>
            <option value="high">높음</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="pill accent" id="recompute">오늘의 추천 다시 뽑기</button>
        <span class="hint">기분/에너지 바꾸고 누르면 추천이 재계산돼요.</span>
      </div>
    </section>

    <!-- 입력 -->
    <section class="card grow">
      <h3 style="margin:0 0 10px">새 작업 추가</h3>
      <div class="grid">
        <div>
          <label>제목</label>
          <input id="title" class="title-input" placeholder="예: 세금 정리, 글 1단락 쓰기" />
        </div>
        <div>
          <label>마감(선택)</label>
          <input id="due" type="date" />
        </div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <label>우선순위</label>
          <select id="priority">
            <option value="3">낮음</option>
            <option value="2" selected>보통</option>
            <option value="1">높음</option>
          </select>
        </div>
        <div>
          <label>필요 에너지</label>
          <select id="effort">
            <option value="low">가벼움</option>
            <option value="mid" selected>보통</option>
            <option value="high">빡셈</option>
          </select>
        </div>
      </div>
      <div style="margin-top:12px">
        <label>메모(선택)</label>
        <textarea id="note" rows="2" placeholder="간단한 설명…"></textarea>
      </div>
      <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="pill accent" id="add">추가</button>
        <button class="pill" id="clearAll">전체 삭제</button>
        <span class="hint">모든 데이터는 브라우저에만 저장됩니다(localStorage).</span>
      </div>
    </section>

    <!-- 추천/오늘 -->
    <section class="card grow">
      <h3 style="margin:0 0 10px">🧭 오늘의 추천</h3>
      <div id="today" class="tasks today-list"></div>
    </section>

    <!-- 전체 목록 -->
    <section class="card grow">
      <h3 style="margin:0 0 10px">📚 전체 작업</h3>
      <div id="list" class="tasks"></div>
    </section>
  </main>

  <script>
    // --- 작은 유틸 ---
    const $ = sel => document.querySelector(sel);
    const uid = () => Math.random().toString(36).slice(2,9);
    const load = (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const todayStr = () => new Date().toISOString().slice(0,10);

    // --- 상태 ---
    let tasks = load('vx_tasks', []);
    let state = load('vx_state', { mood:'mid', energy:'mid', lastRecommended:todayStr(), picks:[] });

    // --- DOM refs ---
    const refs = {
      mood: $('#mood'), energy: $('#energy'),
      title: $('#title'), due: $('#due'),
      priority: $('#priority'), effort: $('#effort'), note: $('#note'),
      add: $('#add'), clearAll: $('#clearAll'), recompute: $('#recompute'),
      list: $('#list'), today: $('#today')
    };

    // --- 렌더 ---
    function render() {
      // 오늘의 추천 렌더
      const picks = state.picks
        .map(id => tasks.find(t => t.id === id))
        .filter(Boolean);
      refs.today.innerHTML = picks.length ? '' : '<div class="empty">추천이 비었어요. 컨디션 맞춰 재추천해보세요.</div>';
      picks.forEach(t => refs.today.appendChild(taskView(t, true)));

      // 전체 목록 렌더 (미완료 우선, 완료는 맨 아래)
      const open = tasks.filter(t => !t.done);
      const done = tasks.filter(t => t.done);
      // 간단 정렬: 마감 임박 ↑, 우선순위 높음 ↑
      open.sort((a,b) => (scoreForSort(b) - scoreForSort(a)));
      refs.list.innerHTML = '';
      [...open, ...done].forEach(t => refs.list.appendChild(taskView(t, false)));
    }

    function scoreForSort(t) {
      const dueFactor = t.due ? (1 / (1 + daysFromToday(t.due))) : 0.25; // 가까울수록 큼
      const prio = (4 - Number(t.priority)); // 1(높음) -> 3점, 3(낮음) -> 1점
      const donePenalty = t.done ? -100 : 0;
      return dueFactor * 3 + prio + donePenalty;
    }

    function daysFromToday(dateStr) {
      const a = new Date(dateStr); a.setHours(0,0,0,0);
      const b = new Date(); b.setHours(0,0,0,0);
      return Math.round((a - b) / 86400000);
    }

    function chip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; return s; }

    function taskView(t, compact=false) {
      const el = document.createElement('div');
      el.className = 'task';
      const left = document.createElement('div');
      const right = document.createElement('div');
      right.className = 'actions';

      const h4 = document.createElement('h4');
      h4.textContent = t.title + (t.done ? ' ✅' : '');
      left.appendChild(h4);

      const meta = document.createElement('div'); meta.className='meta';
      const chips = document.createElement('div'); chips.className='chips';
      chips.appendChild(chip('우선순위 ' + (t.priority === '1' ? '높음' : t.priority === '2' ? '보통' : '낮음')));
      chips.appendChild(chip('필요에너지 ' + t.effort));
      if (t.due) chips.appendChild(chip('마감 ' + t.due + (daysFromToday(t.due)<0?' (지남)':'')));
      meta.appendChild(chips);
      if (t.note) { const n=document.createElement('div'); n.className='muted'; n.textContent=t.note; meta.appendChild(n); }
      left.appendChild(meta);

      // actions
      const btnDone = document.createElement('button');
      btnDone.className='pill';
      btnDone.textContent = t.done ? '복구' : '완료';
      btnDone.onclick = () => { t.done = !t.done; persist(); };

      const btnSnooze = document.createElement('button');
      btnSnooze.className='pill';
      btnSnooze.textContent = '스누즈(내일)';
      btnSnooze.onclick = () => { t.due = shiftDate(t.due ?? todayStr(), 1); persist(); };

      const btnDel = document.createElement('button');
      btnDel.className='pill';
      btnDel.textContent = '삭제';
      btnDel.onclick = () => { tasks = tasks.filter(x => x.id !== t.id); removeFromPicks(t.id); persist(); };

      right.append(btnDone, btnSnooze, btnDel);

      el.append(left, right);
      return el;
    }

    function shiftDate(dateStr, deltaDays){
      const d = new Date(dateStr); d.setDate(d.getDate()+deltaDays);
      return d.toISOString().slice(0,10);
    }

    // --- 추천 로직 ---
    function recommendToday(count=3) {
      const m = refs.mood.value;
      const e = refs.energy.value;
      state.mood = m; state.energy = e;

      // 필터: 완료 제외
      const pool = tasks.filter(t => !t.done);

      // 점수: 우선순위, 마감 임박, 컨디션-작업 매칭
      const scored = pool.map(t => {
        let s = 0;

        // 우선순위 가중
        s += (t.priority === '1' ? 3 : t.priority === '2' ? 2 : 1) * 2;

        // 마감 임박 가중 (가까울수록 ↑)
        if (t.due) {
          const d = daysFromToday(t.due);
          s += (d <= 0 ? 5 : d <= 1 ? 4 : d <= 3 ? 3 : d <= 7 ? 2 : 1);
        } else {
          s += 1;
        }

        // 컨디션-에너지 매칭
        const eff = t.effort; // low/mid/high
        const table = {
          low:  { low:3, mid:1, high:0 },
          mid:  { low:2, mid:3, high:1 },
          high: { low:1, mid:2, high:3 }
        };
        s += table[e][eff];

        // 기분 보정(좋음일수록 난이도 허용 ↑)
        const moodBoost = { low: {low:1,mid:0,high:-1}, mid:{low:1,mid:1,high:0}, high:{low:0,mid:1,high:2} };
        s += moodBoost[m][eff];

        return { t, s };
      });

      scored.sort((a,b)=>b.s-a.s);
      state.picks = scored.slice(0,count).map(x => x.t.id);
      state.lastRecommended = todayStr();
      persist();
    }

    function removeFromPicks(id){
      state.picks = state.picks.filter(x => x !== id);
    }

    // --- 이벤트 ---
    refs.add.onclick = () => {
      const title = refs.title.value.trim();
      if (!title) return;
      const t = {
        id: uid(),
        title,
        due: refs.due.value || '',
        priority: refs.priority.value,
        effort: refs.effort.value,
        note: refs.note.value.trim(),
        done: false,
        createdAt: Date.now()
      };
      tasks.push(t);
      refs.title.value = ''; refs.note.value=''; refs.due.value='';
      persist();
      recommendToday(); // 새 작업 반영
    };

    refs.clearAll.onclick = () => {
      if (!confirm('정말 모든 작업을 삭제할까요?')) return;
      tasks = [];
      state.picks = [];
      persist();
    };

    refs.recompute.onclick = () => { recommendToday(); };

    refs.mood.onchange = () => { state.mood = refs.mood.value; save('vx_state', state); };
    refs.energy.onchange = () => { state.energy = refs.energy.value; save('vx_state', state); };

    // --- 저장/복구 ---
    function persist(){
      save('vx_tasks', tasks);
      save('vx_state', state);
      render();
    }

    function restore() {
      refs.mood.value = state.mood;
      refs.energy.value = state.energy;

      // 하루에 한 번 자동 추천(오늘 처음 열면)
      if (state.lastRecommended !== todayStr()) recommendToday();
      render();
    }

    restore();
  </script>
</body>
</html>