<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="https://mrdindoin.ddns.net/ingo/images/favicon.ico?r=wof01">
<title>RKF ì±„ë¹„ ì—ë””í„° Â· Pride Edition</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#121821; --ink:#dfe7f2; --muted:#8ca0b3; --accent:#66d9ff; --ok:#76e39e; --warn:#ffc857; --bad:#ff6b6b;
    --grid:#1a2430; --edge:#1f2b3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Apple Color Emoji,sans-serif}
  header{display:flex;align-items:center;gap:12px;padding:10px 14px;border-bottom:1px solid var(--edge);background:linear-gradient(180deg,#0c121a,#0a0e14)}
  header h1{font-size:16px;margin:0;letter-spacing:.3px}
  header .subtitle{color:var(--muted)}
  header .right{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  button,.chip,select{background:var(--panel);border:1px solid var(--edge);color:var(--ink);padding:8px 10px;border-radius:8px;cursor:pointer}
  button:hover,.chip:hover,select:hover{border-color:#2b3a50}
  .chip{font-size:12px}
  main{display:grid;grid-template-columns:280px 1fr 320px;gap:12px;padding:12px;height:calc(100% - 56px)}
  .panel{background:var(--panel);border:1px solid var(--edge);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
  .panel h2{font-size:13px;margin:0;padding:10px 12px;border-bottom:1px solid var(--edge);color:var(--muted);letter-spacing:.4px}
  .list{padding:10px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;overflow:auto}
  .card{border:1px solid var(--edge);border-radius:10px;padding:8px;background:#0e141c;display:flex;flex-direction:column;gap:6px;cursor:grab}
  .card strong{font-size:12px}
  .card small{color:var(--muted)}
  .workspace{display:grid;grid-template-rows:240px 1fr;gap:10px;padding:10px}
  .canvas-wrap{position:relative;border:1px dashed var(--grid);border-radius:10px;background:
     linear-gradient(180deg,#0b1119 60%,#081018 60%),
     repeating-linear-gradient(0deg,transparent,transparent 28px,rgba(255,255,255,.03) 28px,rgba(255,255,255,.03) 29px);
  }
  canvas{display:block;width:100%;height:100%}
  .slots{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .slot{border:1px dashed var(--grid);border-radius:8px;min-height:60px;padding:8px;background:#0d131c;display:flex;flex-direction:column;gap:6px}
  .slot header{all:unset;display:flex;justify-content:space-between;align-items:center}
  .slot header b{font-size:12px;color:var(--muted)}
  .slot .pill{padding:6px 8px;border:1px solid var(--edge);border-radius:7px;background:#0c1219;display:flex;justify-content:space-between;gap:6px;align-items:center}
  .slot .pill code{color:var(--accent);font-size:12px}
  .slot.dragover{outline:2px dashed var(--accent)}
  .meters{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .meter{background:#0d131c;border:1px solid var(--edge);border-radius:8px;padding:8px}
  .meter b{font-size:12px;color:var(--muted)}
  .bar{height:10px;background:#0a0f15;border-radius:999px;overflow:hidden;margin-top:6px;border:1px solid var(--edge)}
  .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--bad),var(--warn),var(--ok));transition:width .25s}
  .right-side{padding:10px;display:grid;grid-template-rows:auto auto 1fr;gap:10px}
  .group{border:1px solid var(--edge);border-radius:10px;padding:8px;background:#0d131c}
  .group h3{margin:0 0 6px 0;font-size:13px;color:var(--muted)}
  .table{display:grid;grid-template-columns:120px 1fr;gap:6px;align-items:center}
  .muted{color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,Menlo,monospace;background:#0b1016;border:1px solid var(--edge);padding:2px 6px;border-radius:6px}
  .log{overflow:auto;background:#0b1016;border-radius:8px;border:1px solid var(--edge);padding:8px;font:12px/1.5 ui-monospace,Menlo,monospace}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .pill-btn{padding:6px 8px;border:1px solid var(--edge);border-radius:999px;cursor:pointer;background:#0c1219}
  footer{position:fixed;right:12px;bottom:12px;background:#0c1219;border:1px solid var(--edge);border-radius:10px;padding:8px 10px;color:var(--muted)}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#0c1219;border:1px solid var(--edge);padding:10px 12px;border-radius:10px;display:none}
  .toast.show{display:block}
</style>
</head>
<body>
<header>
  <h1>RKF ì±„ë¹„ ì—ë””í„°</h1>
  <div class="subtitle">Retro Korean Fishing Â· Pride Edition</div>
  <div class="right">
    <button id="btnExport">Export JSON</button>
    <button id="btnImport">Import JSON</button>
    <button id="btnPreset">Demo Preset</button>
    <select id="mode">
      <option value="arcade">Arcade (ê°€ì´ë“œ)</option>
      <option value="strict">Strict (ë¦¬ì–¼)</option>
    </select>
    <span class="chip">âˆ ë‹¨ì¶•í‚¤: <span class="kbd">Space</span> ë¯¸ë¦¬ë³´ê¸° Â· <span class="kbd">S</span> ì±”ì§ˆ</span>
  </div>
</header>

<main>
  <!-- ì™¼ìª½: ë¶€í’ˆ íŒ”ë ˆíŠ¸ -->
  <section class="panel">
    <h2>ë¶€í’ˆ íŒ”ë ˆíŠ¸ (Drag & Drop)</h2>
    <div id="palette" class="list" aria-label="palette"></div>
  </section>

  <!-- ê°€ìš´ë°: ì‘ì—…ì˜ì—­ -->
  <section class="panel workspace">
    <div class="canvas-wrap">
      <canvas id="lake" width="900" height="240" aria-label="float preview"></canvas>
    </div>
    <div>
      <div class="meters" style="margin-bottom:10px">
        <div class="meter"><b>ë¶€ë ¥ ë°¸ëŸ°ìŠ¤</b><div class="bar"><i id="barBalance"></i></div><div class="muted" id="lblBalance"></div></div>
        <div class="meter"><b>ë¯¼ê°ë„</b><div class="bar"><i id="barSense"></i></div><div class="muted" id="lblSense"></div></div>
        <div class="meter"><b>ì•ˆì •ì„±</b><div class="bar"><i id="barStab"></i></div><div class="muted" id="lblStab"></div></div>
      </div>
      <div class="slots" id="slots"></div>
    </div>
  </section>

  <!-- ì˜¤ë¥¸ìª½: í™˜ê²½Â·ì…ì§ˆÂ·ë¡œê·¸ -->
  <aside class="panel right-side">
    <div class="group">
      <h3>í™˜ê²½ ì„¤ì •</h3>
      <div class="table">
        <div class="muted">ìˆ˜ì—­</div>
        <select id="envSelect"></select>
        <div class="muted">ë°”ëŒ</div>
        <input id="wind" type="range" min="0" max="1" step="0.01" />
        <div class="muted">ìœ ì†</div>
        <input id="current" type="range" min="0" max="1" step="0.01" />
        <div class="muted">í™œì„±ë„ ë³´ì •</div>
        <input id="activity" type="range" min="-0.3" max="0.3" step="0.01" />
      </div>
      <div class="row" style="margin-top:8px">
        <div class="pill-btn" id="btnPreview">ì…ì§ˆ ë¯¸ë¦¬ë³´ê¸°</div>
        <div class="pill-btn" id="btnStrike">ì±”ì§ˆ(S)</div>
        <div class="pill-btn" id="btnRandomBite">ëœë¤ íŒ¨í„´</div>
      </div>
    </div>

    <div class="group">
      <h3>ì…ì§ˆ ì‹œê·¸ë‹ˆì²˜</h3>
      <div class="row" id="sigRow"></div>
    </div>

    <div class="group" style="display:flex;flex-direction:column;min-height:0">
      <h3>ì½˜ì†”</h3>
      <div id="log" class="log"></div>
    </div>
  </aside>
</main>

<footer>Tip: ë¶€í’ˆì„ ìŠ¬ë¡¯ì— ë“œë¡­í•˜ë©´ ì¦‰ì‹œ ê³„ì‚° & ìº”ë²„ìŠ¤ì— ì°Œ ë™ì‘ ë°˜ì˜ë©ë‹ˆë‹¤.</footer>
<div id="toast" class="toast"></div>

<script>
/* -----------------------------
   ë°ì´í„° ì‚¬ì „ (ê°„ë‹¨ JSON)
------------------------------*/
const Dict = {
  hooks:{
    hk_iy_06:{id:"hk_iy_06",name:"ì´ì—´ë°”ëŠ˜ 6í˜¸",weight_g:0.12,sharpness:0.85,type:"ìŒë°”ëŠ˜"},
    hk_iy_05:{id:"hk_iy_05",name:"ì´ì—´ë°”ëŠ˜ 5í˜¸",weight_g:0.10,sharpness:0.9,type:"ìŒë°”ëŠ˜"},
    hk_single_07:{id:"hk_single_07",name:"ë‹¨ë°”ëŠ˜ 7í˜¸",weight_g:0.08,sharpness:0.8,type:"ë‹¨ë°”ëŠ˜"},
  },
  lines:{
    ln_12:{id:"ln_12",material:"ë‚˜ì¼ë¡ ",stretch:0.18,lb:1.2},
    ln_16:{id:"ln_16",material:"ì¹´ë³¸",stretch:0.12,lb:1.6},
  },
  floats:{
    fl_slim_12:{id:"fl_slim_12",name:"ìŠ¬ë¦¼ 1.2g",buoyancy_g:1.2,sensitivity:0.85,stability:0.7,body:"ìŠ¬ë¦¼"},
    fl_fat_16:{id:"fl_fat_16",name:"ë³¼ë¡ 1.6g",buoyancy_g:1.6,sensitivity:0.6,stability:0.9,body:"ë³¼ë¡"},
  },
  sinkers:{
    sk_sg_05:{id:"sk_sg_05",name:"ë´‰ëŒ 0.5g",weight_g:0.5,position:"ìœ ë™"},
    sk_fix_08:{id:"sk_fix_08",name:"ë´‰ëŒ 0.8g",weight_g:0.8,position:"ê³ ì •"},
  },
  swivels:{
    sw_std:{id:"sw_std",name:"í‘œì¤€ ë„ë˜",friction:0.05},
    sw_low:{id:"sw_low",name:"ì €ë§ˆì°° ë„ë˜",friction:0.02},
  },
  baits:{
    bt_dough_sweet:{id:"bt_dough_sweet",name:"ë–¡ë°¥(ë‹¨ë§›)",density:1.05,viscosity:0.7,dissolve_s:180},
    bt_worm:{id:"bt_worm",name:"ì§€ë ì´",density:1.03,viscosity:0.3,dissolve_s:999},
  },
  envs:[
    {id:"lake_default",name:"ì”ì”í•œ ì €ìˆ˜ì§€",wind:0.1,current:0.05,activity:0.1},
    {id:"windy",name:"ë°”ëŒ ë¶€ëŠ” ë‚ ",wind:0.6,current:0.2,activity:-0.05},
    {id:"clear_cold",name:"ë§‘ê³  ì°¨ê°€ì›€",wind:0.2,current:0.06,activity:-0.15},
  ],
  signatures:[
    {id:"nibble_updown",name:"ì«€ë“-ê¹œë¹¡",pattern:"+2,-2,+3,H500,-1",difficulty:0.5},
    {id:"lift_and_hold",name:"ë“¤ê³ -ë©ˆì¶¤",pattern:"+6,H800",difficulty:0.3},
    {id:"slam_down",name:"ì°ì–´-ë‚´ë¦¼",pattern:"-10",difficulty:0.7},
  ]
};

// ìŠ¬ë¡¯ ì •ì˜
const Slots = [
  {key:"line", label:"ë¼ì¸"},
  {key:"float",label:"ì°Œ"},
  {key:"sinker",label:"ë´‰ëŒ"},
  {key:"swivel",label:"ë„ë˜"},
  {key:"hooks",label:"ë°”ëŠ˜(1~2)"},
  {key:"bait", label:"ë¯¸ë¼"}
];

let Rig = { line:null,float:null,sinker:null,swivel:null,hooks:[],bait:null, depth_cm:140, leader_cm:15, tags:["ì •ì„"] };
let Mode = "arcade";
let CurrentSig = Dict.signatures[0].id;
let Env = {...Dict.envs[0]};

// UI helpers
const $ = sel => document.querySelector(sel);
const log = (msg) => { const el=$("#log"); el.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>`+el.innerHTML; };
const toast = (msg)=>{const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),1200);};

// íŒ”ë ˆíŠ¸ ìƒì„±
function makePalette(){
  const Pal = $("#palette"); Pal.innerHTML="";
  const groups = [
    ["hooks",Dict.hooks],["lines",Dict.lines],["floats",Dict.floats],
    ["sinkers",Dict.sinkers],["swivels",Dict.swivels],["baits",Dict.baits]
  ];
  for(const [type,bag] of groups){
    for(const id in bag){
      const d = bag[id];
      const card = document.createElement("div");
      card.className="card"; card.draggable=true;
      card.dataset.type=type; card.dataset.id=id;
      card.innerHTML = `<strong>${d.name||d.id}</strong><small>${type}</small><small class="muted">${id}</small>`;
      card.addEventListener("dragstart",e=>{
        e.dataTransfer.setData("text/plain", JSON.stringify({type,id}));
      });
      Pal.appendChild(card);
    }
  }
}

// ìŠ¬ë¡¯ ë Œë”ë§
function makeSlots(){
  const root=$("#slots"); root.innerHTML="";
  for(const s of Slots){
    const el=document.createElement("div");
    el.className="slot"; el.dataset.key=s.key;
    el.innerHTML = `
      <header><b>${s.label}</b><span class="muted">${s.key}</span></header>
      <div class="holder"></div>
    `;
    // ë“œë¡­ ì˜ì—­
    el.addEventListener("dragover",e=>{e.preventDefault(); el.classList.add("dragover");});
    el.addEventListener("dragleave",()=>el.classList.remove("dragover"));
    el.addEventListener("drop",e=>{
      e.preventDefault(); el.classList.remove("dragover");
      try{
        const {type,id} = JSON.parse(e.dataTransfer.getData("text/plain"));
        assignToSlot(s.key,type,id);
      }catch(_){}
    });
    root.appendChild(el);
  }
  refreshSlots();
}

function assignToSlot(slotKey,type,id){
  // íƒ€ì…-ìŠ¬ë¡¯ ê°„ ë§¤í•‘ ê²€ì¦
  const map = { line:"lines", float:"floats", sinker:"sinkers", swivel:"swivels", hooks:"hooks", bait:"baits" };
  if(!map[slotKey]) return toast("ì•Œ ìˆ˜ ì—†ëŠ” ìŠ¬ë¡¯");
  if(map[slotKey]!==type) return toast(`ì´ ìŠ¬ë¡¯ì—ëŠ” ${type} ëŒ€ì‹  ${map[slotKey]} ì¢…ë¥˜ê°€ í•„ìš”í•©ë‹ˆë‹¤`);
  if(slotKey==="hooks"){
    if(Rig.hooks.length>=2) Rig.hooks.shift();
    Rig.hooks.push(id);
  }else{
    Rig[slotKey]=id;
  }
  refreshSlots(); calcAndPaint(); log(`ìŠ¬ë¡¯ '${slotKey}'ì— ${id} ì¥ì°©`);
}

function removeFromSlot(slotKey, idx=null){
  if(slotKey==="hooks"){
    if(idx==null) Rig.hooks=[]; else Rig.hooks.splice(idx,1);
  }else{
    Rig[slotKey]=null;
  }
  refreshSlots(); calcAndPaint();
}

function refreshSlots(){
  for(const slot of $("#slots").children){
    const key = slot.dataset.key;
    const hold = slot.querySelector(".holder");
    hold.innerHTML = "";
    if(key==="hooks"){
      if((Rig.hooks||[]).length===0){
        hold.innerHTML=`<div class="muted">ë°”ëŠ˜ì„ ë“œë¡­í•˜ì„¸ìš” (ìµœëŒ€ 2)</div>`;
      }else{
        Rig.hooks.forEach((id,i)=>{
          const d=Dict.hooks[id];
          const pill=document.createElement("div");
          pill.className="pill";
          pill.innerHTML=`<span>${d.name}</span><code>${id}</code>`;
          pill.title="í´ë¦­í•˜ë©´ ì œê±°"; pill.style.cursor="pointer";
          pill.onclick=()=>removeFromSlot("hooks",i);
          hold.appendChild(pill);
        });
      }
    }else{
      const id = Rig[key];
      if(!id){
        hold.innerHTML=`<div class="muted">ë¶€í’ˆì„ ë“œë¡­í•˜ì„¸ìš”</div>`;
      }else{
        const d = Dict[key+"s"] ? Dict[key+"s"][id] : Dict[key][id];
        const pill=document.createElement("div");
        pill.className="pill";
        pill.innerHTML=`<span>${(d && (d.name||d.id))||id}</span><code>${id}</code>`;
        pill.title="í´ë¦­í•˜ë©´ ì œê±°"; pill.style.cursor="pointer";
        pill.onclick=()=>removeFromSlot(key);
        hold.appendChild(pill);
      }
    }
  }
}

/* -----------------------------
   ë£° ì—”ì§„ (ê°„ì†Œ ë¬¼ë¦¬)
------------------------------*/
function compileRig(rig){
  const F = Dict.floats[rig.float]||{buoyancy_g:0,sensitivity:0,stability:0};
  const S = Dict.sinkers[rig.sinker]||{weight_g:0};
  const L = Dict.lines[rig.line]||{stretch:0.2};
  const Hs = (rig.hooks||[]).map(id=>Dict.hooks[id]).filter(Boolean);
  const B = Dict.baits[rig.bait];

  const hookWeight = Hs.reduce((a,h)=>a+(h.weight_g||0),0);
  const baitLoad = B ? (B.density||1.0)*0.1 : 0; // ë‹¨ìˆœ ì¶”ì • í•˜ì¤‘
  const effectiveLoad = (S.weight_g||0) + hookWeight + baitLoad;
  const buoyancy = (F.buoyancy_g||0);
  const balance = buoyancy - effectiveLoad; // +ë©´ ëœ¸, -ë©´ ê°€ë¼ì•‰ìŒ

  // 0..1 ì •ê·œí™” (ëŒ€ì¶© ë³´ê¸° ì¢‹ê²Œ)
  const balanceScore = Math.max(0, Math.min(1, (balance + 0.5)/1.5));
  const sens = (F.sensitivity||0) * (1 - ((S.weight_g||0)/2.0)) * (1 - (L.stretch||0.2));
  const sensitivityScore = Math.max(0, Math.min(1, sens));
  const stabilityScore = Math.max(0, Math.min(1, (F.stability||0) * (1 - Env.wind*0.5) * (1 - Env.current*0.5)));

  // í›…ì…‹ í™•ë¥  (ì°¸ê³ ì¹˜)
  const sharp = Hs.length? (Hs.reduce((a,h)=>a+(h.sharpness||0),0)/Hs.length) : 0.7;
  const hookSetProb = Math.max(0, Math.min(1, sensitivityScore*0.7 + sharp*0.3));

  return {balance,balanceScore,sensitivityScore,stabilityScore,hookSetProb, parts:{F,S,L,Hs,B}};
}

function updateMeters(stats){
  $("#barBalance").style.width = (stats.balanceScore*100)+"%";
  $("#barSense").style.width   = (stats.sensitivityScore*100)+"%";
  $("#barStab").style.width    = (stats.stabilityScore*100)+"%";
  $("#lblBalance").textContent = `ì”ë¶€ë ¥ ${stats.balance.toFixed(2)} g (ì´ìƒì : ì•½ 0~+0.2g)`;
  $("#lblSense").textContent   = `ë¯¼ê°ë„ ${(stats.sensitivityScore*100|0)}%`;
  $("#lblStab").textContent    = `ì•ˆì •ì„± ${(stats.stabilityScore*100|0)}% (ë°”ëŒ/ìœ ì† ë°˜ì˜)`;
}

/* -----------------------------
   ìº”ë²„ìŠ¤: ì°Œ ì• ë‹ˆë©”ì´ì…˜ & ì…ì§ˆ íŒ¨í„´
------------------------------*/
const lake = $("#lake"); const ctx = lake.getContext("2d",{alpha:false});
let anim = { y: 120, vy:0, t:0, playing:false, queue:[], holdUntil:0 };

function drawLake(){
  // ë°°ê²½ ìˆ˜ë©´ ë¼ì¸
  ctx.clearRect(0,0,lake.width,lake.height);
  // ìˆ˜ë©´ (ìƒë‹¨ 60%)
  ctx.fillStyle = "#0b1119";
  ctx.fillRect(0,0,lake.width, Math.floor(lake.height*0.6));
  // ìˆ˜ì¤‘
  ctx.fillStyle = "#081018";
  ctx.fillRect(0,Math.floor(lake.height*0.6),lake.width,lake.height);

  // ê·¸ë¦¬ë“œ ë¬¼ê²°
  const h = lake.height;
  ctx.fillStyle = "rgba(255,255,255,0.03)";
  for(let y=0;y<Math.floor(h*0.6);y+=28){ ctx.fillRect(0,y,lake.width,1); }

  // ì°Œ(ê°„ë‹¨ ë§‰ëŒ€)
  const x = lake.width*0.5;
  const y = anim.y;
  // ë°”ëŒ/ìœ ì† ë…¸ì´ì¦ˆ
  const noise = (Math.sin(anim.t*0.015)*Env.wind*6) + (Math.cos(anim.t*0.02)*Env.current*4);
  const tipX = x + noise;
  // ë§‰ëŒ€
  ctx.strokeStyle = "#e2f0ff"; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(tipX, y-40); ctx.lineTo(tipX, y+40); ctx.stroke();
  // íŒ
  ctx.strokeStyle = "#ff5c5c"; ctx.lineWidth = 5;
  ctx.beginPath(); ctx.moveTo(tipX, y-42); ctx.lineTo(tipX, y-30); ctx.stroke();
}

function step(){
  anim.t += 1;
  // ê¸°ë³¸ ë¶€ë ¥ ìœ„ì¹˜(ì •ê·œí™”) = ë°¸ëŸ°ìŠ¤ì— ë”°ë¼ ìˆ˜ë©´ ìœ„/ì•„ë˜
  const stats = compileRig(Rig);
  // ëª©í‘œ y: ìˆ˜ë©´ ì¤‘ì•™(=120) ê¸°ì¤€ìœ¼ë¡œ balanceê°€ +ë©´ ìœ„ë¡œ ì¡°ê¸ˆ ì†ŸìŒ, -ë©´ ê°€ë¼ì•‰ìŒ
  const target = 120 - stats.balance*18;
  anim.y += (target - anim.y)*0.08; // ìŠ¤í”„ë§

  // ì…ì§ˆ í ì²˜ë¦¬
  if(anim.queue.length>0){
    // hold ì¤‘?
    if(anim.holdUntil>anim.t){
      // ìœ ì§€
    }else{
      const cmd = anim.queue.shift();
      if(cmd.type==="delta"){
        anim.y += cmd.value; // ì¦‰ì‹œ ë³€ìœ„
      }else if(cmd.type==="hold"){
        anim.holdUntil = anim.t + cmd.ms/16; // 60fps ê°€ì •ì¹˜ ê·¼ì‚¬
      }
    }
  }else{
    anim.playing=false;
  }

  drawLake();
  requestAnimationFrame(step);
}

function parsePattern(str){
  // ì˜ˆ: "+2,-2,+3,H500,-1"
  return str.split(",").map(tok=>{
    tok = tok.trim();
    if(/^H\d+$/i.test(tok)) return {type:"hold",ms:parseInt(tok.slice(1),10)};
    const n = parseFloat(tok);
    if(!isNaN(n)) return {type:"delta",value:n};
    if(tok.startsWith("+")||tok.startsWith("-")) return {type:"delta",value:parseFloat(tok)};
    return null;
  }).filter(Boolean);
}

function playSignature(id){
  const sig = Dict.signatures.find(s=>s.id===id)||Dict.signatures[0];
  anim.queue = parsePattern(sig.pattern);
  anim.playing=true; log(`ì…ì§ˆ íŒ¨í„´ ì‹¤í–‰: ${sig.name}`);
}

/* -----------------------------
   í™˜ê²½ UI
------------------------------*/
function buildEnvUI(){
  const sel = $("#envSelect");
  sel.innerHTML = Dict.envs.map(e=>`<option value="${e.id}">${e.name}</option>`).join("");
  sel.value = Env.id;
  sel.onchange = ()=>{
    const found = Dict.envs.find(x=>x.id===sel.value);
    if(found){ Env = {...found}; syncEnvSliders(); log(`í™˜ê²½ ë³€ê²½: ${Env.name}`); }
  };
  $("#wind").value = Env.wind;
  $("#current").value = Env.current;
  $("#activity").value = Env.activity;
  $("#wind").oninput = e=>{ Env.wind = parseFloat(e.target.value); };
  $("#current").oninput = e=>{ Env.current = parseFloat(e.target.value); };
  $("#activity").oninput = e=>{ Env.activity = parseFloat(e.target.value); };
}
function syncEnvSliders(){
  $("#wind").value = Env.wind;
  $("#current").value = Env.current;
  $("#activity").value = Env.activity;
  $("#envSelect").value = Env.id;
}

/* -----------------------------
   ì‹œê·¸ë‹ˆì²˜ ëª©ë¡ / ëœë¤
------------------------------*/
function buildSigRow(){
  const row=$("#sigRow"); row.innerHTML="";
  Dict.signatures.forEach(sig=>{
    const btn=document.createElement("div");
    btn.className="pill-btn"; btn.textContent=sig.name;
    btn.onclick=()=>{ CurrentSig=sig.id; playSignature(sig.id); };
    row.appendChild(btn);
  });
}
function randomSignature(){
  const pick = Dict.signatures[(Math.random()*Dict.signatures.length)|0];
  CurrentSig = pick.id; playSignature(pick.id);
}

/* -----------------------------
   Export/Import & Preset
------------------------------*/
function exportJSON(){
  const data = {rig:Rig, mode:Mode, env:Env};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rkf_rig.json";
  a.click();
  URL.revokeObjectURL(a.href);
  toast("JSON ë‚´ë³´ë‚´ê¸° ì™„ë£Œ");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange = ()=>{
    const f = inp.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = ()=>{
      try{
        const j = JSON.parse(fr.result);
        Rig = j.rig||Rig; Mode = j.mode||Mode; Env = j.env||Env;
        $("#mode").value = Mode; syncEnvSliders(); refreshSlots(); calcAndPaint();
        toast("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ");
      }catch(err){ toast("JSON íŒŒì‹± ì‹¤íŒ¨"); }
    };
    fr.readAsText(f);
  };
  inp.click();
}
function demoPreset(){
  Rig = { line:"ln_12", float:"fl_slim_12", sinker:"sk_sg_05", swivel:"sw_std", hooks:["hk_iy_06"], bait:"bt_dough_sweet", depth_cm:140, leader_cm:15, tags:["ì •ì„","ë¯¼ê°"] };
  refreshSlots(); calcAndPaint();
  toast("ë°ëª¨ ì±„ë¹„ ë¡œë“œ");
}

/* -----------------------------
   íŒì •/ì±”ì§ˆ
------------------------------*/
let lastStrikeOk=false;
function strike(){
  const stats = compileRig(Rig);
  // ëª¨ë“œë³„ ë³´ì •
  const timing = Mode==="arcade" ? 0.85 : 0.55; // ì‚¬ìš©ìê°€ ì˜ ëˆŒë €ë‹¤ê³  ê°€ì •í•œ ê°€ì¤‘ì¹˜
  const prob = Math.max(0, Math.min(1, stats.hookSetProb*0.7 + timing*0.3));
  const ok = Math.random() < prob;
  lastStrikeOk = ok;
  if(ok){ toast("í›…ì…‹ ì„±ê³µ! ğŸ£"); log(`ì±”ì§ˆ ì„±ê³µ (p=${prob.toFixed(2)})`); }
  else{ toast("í›…ì…‹ ì‹¤íŒ¨"); log(`ì±”ì§ˆ ì‹¤íŒ¨ (p=${prob.toFixed(2)})`); }
}

/* -----------------------------
   ë©”ì¸ ë°”ì¸ë”©
------------------------------*/
function calcAndPaint(){
  const stats = compileRig(Rig);
  updateMeters(stats);
  // ì”ë¶€ë ¥ì— ë§ì¶° ê¸°ë³¸ ìœ„ì¹˜ ì•½ê°„ ì¡°ì •
  drawLake();
}

function bindTop(){
  $("#btnExport").onclick=exportJSON;
  $("#btnImport").onclick=importJSON;
  $("#btnPreset").onclick=demoPreset;
  $("#mode").onchange=e=>{ Mode=e.target.value; toast(`ëª¨ë“œ: ${Mode}`); };
}
function bindRight(){
  $("#btnPreview").onclick=()=>playSignature(CurrentSig);
  $("#btnStrike").onclick=strike;
  $("#btnRandomBite").onclick=randomSignature;
}
function bindKeys(){
  window.addEventListener("keydown",e=>{
    if(e.code==="Space"){ e.preventDefault(); playSignature(CurrentSig); }
    if(e.key==="s"||e.key==="S"){ strike(); }
    if(e.key==="1"){ $("#mode").value="arcade"; Mode="arcade"; toast("Arcade"); }
    if(e.key==="2"){ $("#mode").value="strict"; Mode="strict"; toast("Strict"); }
  });
}

/* -----------------------------
   init
------------------------------*/
function init(){
  makePalette(); makeSlots(); buildEnvUI(); buildSigRow(); bindTop(); bindRight(); bindKeys();
  calcAndPaint(); requestAnimationFrame(step);
  log("ì—ë””í„° ì¤€ë¹„ ì™„ë£Œ. íŒ”ë ˆíŠ¸ì—ì„œ ìŠ¬ë¡¯ìœ¼ë¡œ ë“œë˜ê·¸í•´ ì¡°ë¦½í•˜ì„¸ìš”.");
}
init();
</script>
</body>
</html>
